<?php
session_start();
// Include the configuration file
require_once 'config.php';
// Create connection
$conn = new mysqli($servername, $username, $password, $dbname);
// Check connection
if ($conn->connect_error) {
    die("Connection failed: " . $conn->connect_error);
}
// Check if user is logged in
if (!isset($_SESSION['user_id'])) {
    header("Location: index.php");
    exit();
}
// Check if user is HR/admin (you might need to adjust this based on your user roles)
$is_hr = true; // For demo purposes, set to true. Implement proper role checking
// Handle navigation item clicks
$active_section = isset($_GET['section']) ? $_GET['section'] : 'overview';
// Handle report actions
if (isset($_GET['action']) && isset($_GET['report_id'])) {
    $report_id = intval($_GET['report_id']);
    $action = $_GET['action'];
    
    // Get report details
    $report_sql = "SELECT pr.*, CONCAT(e.first_name, ' ', e.last_name) as employee_name, e.department,
                   CONCAT(rb.first_name, ' ', rb.last_name) as report_generated_by_name
                   FROM performance_reviews pr
                   LEFT JOIN employees e ON pr.employee_id = e.id
                   LEFT JOIN employees rb ON pr.report_generated_by = rb.id
                   WHERE pr.id = $report_id AND pr.report_category IS NOT NULL";
    $report_result = $conn->query($report_sql);
    
    if ($report_result->num_rows > 0) {
        $report = $report_result->fetch_assoc();
        
        if ($action == 'view') {
            // Set up content for viewing the report
            $report_content = generateReportContent($report, $conn);
            // We'll pass this content to JavaScript to display in a modal
            $view_report_data = [
                'id' => $report['id'],
                'title' => $report['report_category'] . ' Report',
                'content' => $report_content
            ];
        } elseif ($action == 'download') {
            // Generate and download the report as a file
            $report_content = generateReportContent($report, $conn);
            $filename = $report['report_category'] . '_Report_' . date('Y-m-d') . '.html';
            
            header('Content-Type: application/octet-stream');
            header('Content-Disposition: attachment; filename="' . $filename . '"');
            header('Content-Length: ' . strlen($report_content));
            echo $report_content;
            exit();
        }
    }
}
// Function to generate report content based on report type
function generateReportContent($report, $conn) {
    $report_type = $report['report_category'];
    $report_period = $report['report_period'];
    $report_department = isset($report['department']) ? $report['department'] : null;
    
    // Start building HTML content
    $content = '<!DOCTYPE html>
    <html>
    <head>
        <title>' . $report_type . ' Report</title>
        <style>
            body { font-family: Arial, sans-serif; margin: 20px; }
            h1, h2, h3 { color: #1a2a6c; }
            table { width: 100%; border-collapse: collapse; margin: 20px 0; }
            th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
            th { background-color: #f2f2f2; }
            .header { text-align: center; margin-bottom: 30px; }
            .footer { margin-top: 30px; text-align: center; font-size: 12px; color: #777; }
        </style>
    </head>
    <body>
        <div class="header">
            <h1>' . $report_type . ' Report</h1>
            <p>Period: ' . $report_period . '</p>
            <p>Generated on: ' . date('F j, Y', strtotime($report['report_generated_date'])) . '</p>
            <p>Generated by: ' . $report['report_generated_by_name'] . '</p>';
    
    if ($report_department) {
        $content .= '<p>Department: ' . $report_department . '</p>';
    }
    
    $content .= '</div>';
    
    // Add specific content based on report type
    switch ($report_type) {
        case 'Performance Summary':
            $content .= generatePerformanceSummary($report_period, $report_department, $conn);
            break;
        case 'Department Comparison':
            $content .= generateDepartmentComparison($report_period, $conn);
            break;
        case 'Top Performers':
            $content .= generateTopPerformers($report_period, $report_department, $conn);
            break;
        case 'Improvement Needed':
            $content .= generateImprovementNeeded($report_period, $report_department, $conn);
            break;
        case 'Goal Progress':
            $content .= generateGoalProgress($report_period, $report_department, $conn);
            break;
        default:
            $content .= '<p>No specific content available for this report type.</p>';
    }
    
    $content .= '<div class="footer">
        <p>This report was generated by the Performance Management System.</p>
        <p>Â© ' . date('Y') . ' Buymeabook. All rights reserved.</p>
    </div>
    </body>
    </html>';
    
    return $content;
}

function generatePerformanceSummary($period, $department, $conn) {
    $content = '<h2>Performance Summary</h2>';
    
    // Build date filter based on period
    $date_filter = "";
    $current_date = date('Y-m-d');
    $current_year = date('Y');
    $current_quarter = ceil(date('n') / 3);
    $last_quarter = $current_quarter == 1 ? 4 : $current_quarter - 1;
    $last_quarter_year = $current_quarter == 1 ? $current_year - 1 : $current_year;
    
    switch ($period) {
        case 'Monthly':
            $start_date = date('Y-m-01');
            $date_filter = "AND pr.review_date BETWEEN '$start_date' AND '$current_date'";
            break;
        case 'Quarterly':
            $quarter_start = date('Y-m-d', mktime(0, 0, 0, ($current_quarter - 1) * 3 + 1, 1, $current_year));
            $date_filter = "AND pr.review_date BETWEEN '$quarter_start' AND '$current_date'";
            break;
        case 'Semi-Annual':
            $half_year = date('n') <= 6 ? 1 : 2;
            $start_date = $half_year == 1 ? date('Y-01-01') : date('Y-07-01');
            $date_filter = "AND pr.review_date BETWEEN '$start_date' AND '$current_date'";
            break;
        case 'Annual':
            $start_date = date('Y-01-01');
            $date_filter = "AND pr.review_date BETWEEN '$start_date' AND '$current_date'";
            break;
        case 'Custom':
            // For custom, we'll use the last 30 days
            $start_date = date('Y-m-d', strtotime('-30 days'));
            $date_filter = "AND pr.review_date BETWEEN '$start_date' AND '$current_date'";
            break;
    }
    
    // Build department filter
    $dept_filter = "";
    if (!empty($department)) {
        $dept_filter = "AND e.department = '" . $conn->real_escape_string($department) . "'";
    }
    
    // Get overall performance metrics
    $metrics_sql = "SELECT 
                  AVG(pr.performance_rating) as avg_rating,
                  COUNT(*) as total_reviews,
                  SUM(CASE WHEN pr.performance_rating >= 8 THEN 1 ELSE 0 END) as top_performers,
                  SUM(CASE WHEN pr.performance_rating <= 5 THEN 1 ELSE 0 END) as needs_improvement
                  FROM performance_reviews pr
                  JOIN employees e ON pr.employee_id = e.id
                  WHERE pr.performance_rating IS NOT NULL $date_filter $dept_filter";
    $metrics_result = $conn->query($metrics_sql);
    
    if ($metrics_result->num_rows > 0) {
        $metrics = $metrics_result->fetch_assoc();
        
        $content .= '<h3>Overall Performance Metrics</h3>
        <table>
            <tr>
                <th>Metric</th>
                <th>Value</th>
            </tr>
            <tr>
                <td>Average Rating</td>
                <td>' . round($metrics['avg_rating'], 2) . '/10</td>
            </tr>
            <tr>
                <td>Total Reviews</td>
                <td>' . $metrics['total_reviews'] . '</td>
            </tr>
            <tr>
                <td>Top Performers</td>
                <td>' . $metrics['top_performers'] . '</td>
            </tr>
            <tr>
                <td>Needs Improvement</td>
                <td>' . $metrics['needs_improvement'] . '</td>
            </tr>
        </table>';
    }
    
    // Get department performance if not filtered by department
    if (empty($department)) {
        $dept_sql = "SELECT e.department, 
                    AVG(pr.performance_rating) as avg_rating,
                    COUNT(*) as total_reviews
                    FROM performance_reviews pr
                    JOIN employees e ON pr.employee_id = e.id
                    WHERE pr.performance_rating IS NOT NULL $date_filter
                    GROUP BY e.department
                    ORDER BY avg_rating DESC";
        $dept_result = $conn->query($dept_sql);
        
        if ($dept_result->num_rows > 0) {
            $content .= '<h3>Performance by Department</h3>
            <table>
                <tr>
                    <th>Department</th>
                    <th>Average Rating</th>
                    <th>Total Reviews</th>
                </tr>';
            
            while ($dept = $dept_result->fetch_assoc()) {
                $content .= '<tr>
                    <td>' . htmlspecialchars($dept['department']) . '</td>
                    <td>' . round($dept['avg_rating'], 2) . '/10</td>
                    <td>' . $dept['total_reviews'] . '</td>
                </tr>';
            }
            
            $content .= '</table>';
        }
    }
    
    return $content;
}

function generateDepartmentComparison($period, $conn) {
    $content = '<h2>Department Comparison</h2>';
    
    // Build date filter based on period
    $date_filter = "";
    $current_date = date('Y-m-d');
    $current_year = date('Y');
    $current_quarter = ceil(date('n') / 3);
    
    switch ($period) {
        case 'Monthly':
            $start_date = date('Y-m-01');
            $date_filter = "AND pr.review_date BETWEEN '$start_date' AND '$current_date'";
            break;
        case 'Quarterly':
            $quarter_start = date('Y-m-d', mktime(0, 0, 0, ($current_quarter - 1) * 3 + 1, 1, $current_year));
            $date_filter = "AND pr.review_date BETWEEN '$quarter_start' AND '$current_date'";
            break;
        case 'Semi-Annual':
            $half_year = date('n') <= 6 ? 1 : 2;
            $start_date = $half_year == 1 ? date('Y-01-01') : date('Y-07-01');
            $date_filter = "AND pr.review_date BETWEEN '$start_date' AND '$current_date'";
            break;
        case 'Annual':
            $start_date = date('Y-01-01');
            $date_filter = "AND pr.review_date BETWEEN '$start_date' AND '$current_date'";
            break;
        case 'Custom':
            // For custom, we'll use the last 30 days
            $start_date = date('Y-m-d', strtotime('-30 days'));
            $date_filter = "AND pr.review_date BETWEEN '$start_date' AND '$current_date'";
            break;
    }
    
    // Get department performance metrics
    $dept_sql = "SELECT e.department, 
                AVG(pr.performance_rating) as avg_rating,
                COUNT(*) as total_reviews,
                SUM(CASE WHEN pr.performance_rating >= 8 THEN 1 ELSE 0 END) as top_performers,
                SUM(CASE WHEN pr.performance_rating <= 5 THEN 1 ELSE 0 END) as needs_improvement
                FROM performance_reviews pr
                JOIN employees e ON pr.employee_id = e.id
                WHERE pr.performance_rating IS NOT NULL $date_filter
                GROUP BY e.department
                ORDER BY avg_rating DESC";
    $dept_result = $conn->query($dept_sql);
    
    if ($dept_result->num_rows > 0) {
        $content .= '<table>
            <tr>
                <th>Department</th>
                <th>Average Rating</th>
                <th>Total Reviews</th>
                <th>Top Performers</th>
                <th>Needs Improvement</th>
            </tr>';
        
        while ($dept = $dept_result->fetch_assoc()) {
            $content .= '<tr>
                <td>' . htmlspecialchars($dept['department']) . '</td>
                <td>' . round($dept['avg_rating'], 2) . '/10</td>
                <td>' . $dept['total_reviews'] . '</td>
                <td>' . $dept['top_performers'] . '</td>
                <td>' . $dept['needs_improvement'] . '</td>
            </tr>';
        }
        
        $content .= '</table>';
    } else {
        $content .= '<p>No department data available for the selected period.</p>';
    }
    
    return $content;
}

function generateTopPerformers($period, $department, $conn) {
    $content = '<h2>Top Performers</h2>';
    
    // Build date filter based on period
    $date_filter = "";
    $current_date = date('Y-m-d');
    $current_year = date('Y');
    $current_quarter = ceil(date('n') / 3);
    
    switch ($period) {
        case 'Monthly':
            $start_date = date('Y-m-01');
            $date_filter = "AND pr.review_date BETWEEN '$start_date' AND '$current_date'";
            break;
        case 'Quarterly':
            $quarter_start = date('Y-m-d', mktime(0, 0, 0, ($current_quarter - 1) * 3 + 1, 1, $current_year));
            $date_filter = "AND pr.review_date BETWEEN '$quarter_start' AND '$current_date'";
            break;
        case 'Semi-Annual':
            $half_year = date('n') <= 6 ? 1 : 2;
            $start_date = $half_year == 1 ? date('Y-01-01') : date('Y-07-01');
            $date_filter = "AND pr.review_date BETWEEN '$start_date' AND '$current_date'";
            break;
        case 'Annual':
            $start_date = date('Y-01-01');
            $date_filter = "AND pr.review_date BETWEEN '$start_date' AND '$current_date'";
            break;
        case 'Custom':
            // For custom, we'll use the last 30 days
            $start_date = date('Y-m-d', strtotime('-30 days'));
            $date_filter = "AND pr.review_date BETWEEN '$start_date' AND '$current_date'";
            break;
    }
    
    // Build department filter
    $dept_filter = "";
    if (!empty($department)) {
        $dept_filter = "AND e.department = '" . $conn->real_escape_string($department) . "'";
    }
    
    // Get top performers
    $top_sql = "SELECT CONCAT(e.first_name, ' ', e.last_name) as employee_name, 
               e.department, pr.performance_rating, pr.review_date,
               pr.strengths, pr.goals_achievement
               FROM performance_reviews pr
               JOIN employees e ON pr.employee_id = e.id
               WHERE pr.performance_rating >= 8 $date_filter $dept_filter
               ORDER BY pr.performance_rating DESC";
    $top_result = $conn->query($top_sql);
    
    if ($top_result->num_rows > 0) {
        $content .= '<table>
            <tr>
                <th>Employee Name</th>
                <th>Department</th>
                <th>Rating</th>
                <th>Review Date</th>
                <th>Strengths</th>
                <th>Goals Achievement</th>
            </tr>';
        
        while ($top = $top_result->fetch_assoc()) {
            $content .= '<tr>
                <td>' . htmlspecialchars($top['employee_name']) . '</td>
                <td>' . htmlspecialchars($top['department']) . '</td>
                <td>' . $top['performance_rating'] . '/10</td>
                <td>' . date('M j, Y', strtotime($top['review_date'])) . '</td>
                <td>' . (htmlspecialchars($top['strengths']) ?: 'N/A') . '</td>
                <td>' . (htmlspecialchars($top['goals_achievement']) ?: 'N/A') . '</td>
            </tr>';
        }
        
        $content .= '</table>';
    } else {
        $content .= '<p>No top performers found for the selected period.</p>';
    }
    
    return $content;
}

function generateImprovementNeeded($period, $department, $conn) {
    $content = '<h2>Employees Needing Improvement</h2>';
    
    // Build date filter based on period
    $date_filter = "";
    $current_date = date('Y-m-d');
    $current_year = date('Y');
    $current_quarter = ceil(date('n') / 3);
    
    switch ($period) {
        case 'Monthly':
            $start_date = date('Y-m-01');
            $date_filter = "AND pr.review_date BETWEEN '$start_date' AND '$current_date'";
            break;
        case 'Quarterly':
            $quarter_start = date('Y-m-d', mktime(0, 0, 0, ($current_quarter - 1) * 3 + 1, 1, $current_year));
            $date_filter = "AND pr.review_date BETWEEN '$quarter_start' AND '$current_date'";
            break;
        case 'Semi-Annual':
            $half_year = date('n') <= 6 ? 1 : 2;
            $start_date = $half_year == 1 ? date('Y-01-01') : date('Y-07-01');
            $date_filter = "AND pr.review_date BETWEEN '$start_date' AND '$current_date'";
            break;
        case 'Annual':
            $start_date = date('Y-01-01');
            $date_filter = "AND pr.review_date BETWEEN '$start_date' AND '$current_date'";
            break;
        case 'Custom':
            // For custom, we'll use the last 30 days
            $start_date = date('Y-m-d', strtotime('-30 days'));
            $date_filter = "AND pr.review_date BETWEEN '$start_date' AND '$current_date'";
            break;
    }
    
    // Build department filter
    $dept_filter = "";
    if (!empty($department)) {
        $dept_filter = "AND e.department = '" . $conn->real_escape_string($department) . "'";
    }
    
    // Get employees needing improvement
    $improve_sql = "SELECT CONCAT(e.first_name, ' ', e.last_name) as employee_name, 
                    e.department, pr.performance_rating, pr.review_date,
                    pr.areas_for_improvement, pr.recommendations
                    FROM performance_reviews pr
                    JOIN employees e ON pr.employee_id = e.id
                    WHERE pr.performance_rating <= 5 $date_filter $dept_filter
                    ORDER BY pr.performance_rating ASC";
    $improve_result = $conn->query($improve_sql);
    
    if ($improve_result->num_rows > 0) {
        $content .= '<table>
            <tr>
                <th>Employee Name</th>
                <th>Department</th>
                <th>Rating</th>
                <th>Review Date</th>
                <th>Areas for Improvement</th>
                <th>Recommendations</th>
            </tr>';
        
        while ($improve = $improve_result->fetch_assoc()) {
            $content .= '<tr>
                <td>' . htmlspecialchars($improve['employee_name']) . '</td>
                <td>' . htmlspecialchars($improve['department']) . '</td>
                <td>' . $improve['performance_rating'] . '/10</td>
                <td>' . date('M j, Y', strtotime($improve['review_date'])) . '</td>
                <td>' . (htmlspecialchars($improve['areas_for_improvement']) ?: 'N/A') . '</td>
                <td>' . (htmlspecialchars($improve['recommendations']) ?: 'N/A') . '</td>
            </tr>';
        }
        
        $content .= '</table>';
    } else {
        $content .= '<p>No employees needing improvement found for the selected period.</p>';
    }
    
    return $content;
}

function generateGoalProgress($period, $department, $conn) {
    $content = '<h2>Goal Progress</h2>';
    
    // Build date filter based on period
    $date_filter = "";
    $current_date = date('Y-m-d');
    $current_year = date('Y');
    $current_quarter = ceil(date('n') / 3);
    
    switch ($period) {
        case 'Monthly':
            $start_date = date('Y-m-01');
            $date_filter = "AND pr.goal_target_date BETWEEN '$start_date' AND '$current_date'";
            break;
        case 'Quarterly':
            $quarter_start = date('Y-m-d', mktime(0, 0, 0, ($current_quarter - 1) * 3 + 1, 1, $current_year));
            $date_filter = "AND pr.goal_target_date BETWEEN '$quarter_start' AND '$current_date'";
            break;
        case 'Semi-Annual':
            $half_year = date('n') <= 6 ? 1 : 2;
            $start_date = $half_year == 1 ? date('Y-01-01') : date('Y-07-01');
            $date_filter = "AND pr.goal_target_date BETWEEN '$start_date' AND '$current_date'";
            break;
        case 'Annual':
            $start_date = date('Y-01-01');
            $date_filter = "AND pr.goal_target_date BETWEEN '$start_date' AND '$current_date'";
            break;
        case 'Custom':
            // For custom, we'll use the last 30 days
            $start_date = date('Y-m-d', strtotime('-30 days'));
            $date_filter = "AND pr.goal_target_date BETWEEN '$start_date' AND '$current_date'";
            break;
    }
    
    // Build department filter
    $dept_filter = "";
    if (!empty($department)) {
        $dept_filter = "AND e.department = '" . $conn->real_escape_string($department) . "'";
    }
    
    // Get goal progress metrics
    $goals_sql = "SELECT CONCAT(e.first_name, ' ', e.last_name) as employee_name, 
                 e.department, pr.goal_description, pr.goal_progress, 
                 pr.goal_status, pr.goal_target_date
                 FROM performance_reviews pr
                 JOIN employees e ON pr.employee_id = e.id
                 WHERE pr.goal_description IS NOT NULL $date_filter $dept_filter
                 ORDER BY pr.goal_progress DESC";
    $goals_result = $conn->query($goals_sql);
    
    if ($goals_result->num_rows > 0) {
        // Calculate goal statistics
        $total_goals = $goals_result->num_rows;
        $completed_goals = 0;
        $in_progress_goals = 0;
        $not_started_goals = 0;
        $avg_progress = 0;
        $total_progress = 0;
        
        $content .= '<h3>Goal Summary</h3>';
        
        $goals_data = [];
        while ($goal = $goals_result->fetch_assoc()) {
            $goals_data[] = $goal;
            $total_progress += $goal['goal_progress'];
            
            if ($goal['goal_progress'] == 100) {
                $completed_goals++;
            } elseif ($goal['goal_progress'] > 0) {
                $in_progress_goals++;
            } else {
                $not_started_goals++;
            }
        }
        
        if ($total_goals > 0) {
            $avg_progress = round($total_progress / $total_goals, 2);
        }
        
        $content .= '<table>
            <tr>
                <th>Metric</th>
                <th>Value</th>
            </tr>
            <tr>
                <td>Total Goals</td>
                <td>' . $total_goals . '</td>
            </tr>
            <tr>
                <td>Completed Goals</td>
                <td>' . $completed_goals . ' (' . round(($completed_goals / $total_goals) * 100, 1) . '%)</td>
            </tr>
            <tr>
                <td>In Progress Goals</td>
                <td>' . $in_progress_goals . ' (' . round(($in_progress_goals / $total_goals) * 100, 1) . '%)</td>
            </tr>
            <tr>
                <td>Not Started Goals</td>
                <td>' . $not_started_goals . ' (' . round(($not_started_goals / $total_goals) * 100, 1) . '%)</td>
            </tr>
            <tr>
                <td>Average Progress</td>
                <td>' . $avg_progress . '%</td>
            </tr>
        </table>';
        
        $content .= '<h3>Goal Details</h3>';
        $content .= '<table>
            <tr>
                <th>Employee Name</th>
                <th>Department</th>
                <th>Goal Description</th>
                <th>Progress</th>
                <th>Status</th>
                <th>Target Date</th>
            </tr>';
        
        foreach ($goals_data as $goal) {
            $progress_bar = '<div style="width: 100px; background-color: #f1f1f1; border-radius: 5px;">
                               <div style="width: ' . $goal['goal_progress'] . '%; background-color: #4CAF50; border-radius: 5px; text-align: center; color: white;">' . $goal['goal_progress'] . '%</div>
                           </div>';
            
            $content .= '<tr>
                <td>' . htmlspecialchars($goal['employee_name']) . '</td>
                <td>' . htmlspecialchars($goal['department']) . '</td>
                <td>' . htmlspecialchars($goal['goal_description']) . '</td>
                <td>' . $progress_bar . '</td>
                <td>' . htmlspecialchars($goal['goal_status']) . '</td>
                <td>' . date('M j, Y', strtotime($goal['goal_target_date'])) . '</td>
            </tr>';
        }
        
        $content .= '</table>';
    } else {
        $content .= '<p>No goals found for the selected period.</p>';
    }
    
    return $content;
}
// Fetch all employees
$employees = array();
$emp_sql = "SELECT id, CONCAT(first_name, ' ', last_name) as name, email, department FROM employees WHERE valid_user = TRUE";
$emp_result = $conn->query($emp_sql);
if ($emp_result->num_rows > 0) {
    while ($row = $emp_result->fetch_assoc()) {
        $employees[] = $row;
    }
}
// Handle goal submission
if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_POST['add_goal'])) {
    $employee_id = $_POST['goal_employee'];
    $goal_title = $conn->real_escape_string($_POST['goal_title']);
    $goal_category = $_POST['goal_category']; // Store this variable for UI purposes
    $goal_start_date = $_POST['goal_start_date'];
    $goal_end_date = $_POST['goal_end_date'];
    $goal_progress = $_POST['goal_progress'];
    $goal_description = !empty($_POST['goal_description']) ? $conn->real_escape_string($_POST['goal_description']) : null;
    $goal_measurement = !empty($_POST['goal_measurement']) ? $conn->real_escape_string($_POST['goal_measurement']) : null;
    
    // Insert into performance_reviews as a goal record
    // FIXED: Removed goal_category from the SQL query since it doesn't exist in the table
    $sql = "INSERT INTO performance_reviews (employee_id, review_date, reviewer_id, goal_description, goal_progress, goal_status, goal_target_date) 
            VALUES ('$employee_id', '$goal_start_date', '" . $_SESSION['user_id'] . "', " .
            ($goal_description ? "'$goal_description'" : "NULL") . ", " .
            ($goal_progress ? "'$goal_progress'" : "0") . ", " .
            "'In Progress', " .
            ($goal_end_date ? "'$goal_end_date'" : "NULL") . ")";
    
    if ($conn->query($sql)) {
        $message = "Goal created successfully!";
        $message_type = "success";
    } else {
        $message = "Error: " . $conn->error;
        $message_type = "error";
    }
}
// Handle recognition submission
if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_POST['add_recognition'])) {
    $employee_id = $_POST['recognition_employee'];
    $recognition_type = $_POST['recognition_type'];
    $recognition_date = $_POST['recognition_date'];
    $recognition_reason = !empty($_POST['recognition_reason']) ? $conn->real_escape_string($_POST['recognition_reason']) : null;
    
    // Insert into performance_reviews as a recognition record
    $sql = "INSERT INTO performance_reviews (employee_id, review_date, reviewer_id, recognition_type, recognition_reason, recognition_date, recognition_given_by) 
            VALUES ('$employee_id', '$recognition_date', '" . $_SESSION['user_id'] . "', " .
            "'$recognition_type', " .
            ($recognition_reason ? "'$recognition_reason'" : "NULL") . ", " .
            "'$recognition_date', '" . $_SESSION['user_id'] . "')";
    
    if ($conn->query($sql)) {
        $message = "Recognition added successfully!";
        $message_type = "success";
    } else {
        $message = "Error: " . $conn->error;
        $message_type = "error";
    }
}
// Handle performance review submission
if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_POST['add_performance'])) {
    $employee_id = $_POST['employee_id'];
    $review_date = $_POST['review_date'];
    $reviewer_id = $_POST['reviewer_id'];
    $performance_rating = !empty($_POST['performance_rating']) ? $_POST['performance_rating'] : null;
    $goals_achievement = !empty($_POST['goals_achievement']) ? $conn->real_escape_string($_POST['goals_achievement']) : null;
    $strengths = !empty($_POST['strengths']) ? $conn->real_escape_string($_POST['strengths']) : null;
    $areas_for_improvement = !empty($_POST['areas_for_improvement']) ? $conn->real_escape_string($_POST['areas_for_improvement']) : null;
    $recommendations = !empty($_POST['recommendations']) ? $conn->real_escape_string($_POST['recommendations']) : null;
    $next_review_date = !empty($_POST['next_review_date']) ? $_POST['next_review_date'] : null;
    
    $sql = "INSERT INTO performance_reviews (employee_id, review_date, reviewer_id, performance_rating, goals_achievement, strengths, areas_for_improvement, recommendations, next_review_date) 
            VALUES ('$employee_id', '$review_date', '$reviewer_id', " . 
            (is_numeric($performance_rating) ? $performance_rating : "NULL") . ", " .
            ($goals_achievement ? "'$goals_achievement'" : "NULL") . ", " .
            ($strengths ? "'$strengths'" : "NULL") . ", " .
            ($areas_for_improvement ? "'$areas_for_improvement'" : "NULL") . ", " .
            ($recommendations ? "'$recommendations'" : "NULL") . ", " .
            ($next_review_date ? "'$next_review_date'" : "NULL") . ")";
    if ($conn->query($sql)) {
        $message = "Performance review added successfully!";
        $message_type = "success";
    } else {
        $message = "Error: " . $conn->error;
        $message_type = "error";
    }
}
// Handle report generation
if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_POST['generate_report'])) {
    $report_type = $_POST['report_type'];
    $report_period = $_POST['report_period'];
    $report_department = !empty($_POST['report_department']) ? $_POST['report_department'] : null;
    $report_generated_date = date('Y-m-d');
    
    // Generate a unique report name
    $report_name = $report_type . ' Report - ' . $report_period;
    if ($report_department) {
        $report_name .= ' - ' . $report_department;
    }
    
    // Get a valid employee ID (use the current user's ID)
    $valid_employee_id = $_SESSION['user_id'];
    
    // Insert into performance_reviews as a report record
    $sql = "INSERT INTO performance_reviews (employee_id, review_date, reviewer_id, report_category, report_period, report_generated_date, report_generated_by) 
            VALUES ('$valid_employee_id', '$report_generated_date', '" . $_SESSION['user_id'] . "', " .
            "'$report_type', " .
            "'$report_period', " .
            "'$report_generated_date', " .
            "'" . $_SESSION['user_id'] . "')";
    
    if ($conn->query($sql)) {
        $message = "Report generated successfully!";
        $message_type = "success";
    } else {
        $message = "Error generating report: " . $conn->error;
        $message_type = "error";
    }
}
// Fetch performance reviews
$performance_reviews = array();
// FIXED: Changed to use 'name' column instead of concatenating first_name and last_name
$perf_sql = "SELECT pr.*, e.name as employee_name, r.name as reviewer_name, e.department
             FROM performance_reviews pr 
             JOIN employees e ON pr.employee_id = e.id 
             JOIN employees r ON pr.reviewer_id = r.id 
             ORDER BY pr.review_date DESC";
$perf_result = $conn->query($perf_sql);
if ($perf_result->num_rows > 0) {
    while ($row = $perf_result->fetch_assoc()) {
        $performance_reviews[] = $row;
    }
}
// Calculate performance statistics for analytics
$performance_stats = array(
    'total_reviews' => 0,
    'avg_rating' => 0,
    'department_stats' => array(),
    'rating_distribution' => array_fill(1, 10, 0)
);
// Only calculate stats if there are reviews
if (count($performance_reviews) > 0) {
    $total_rating = 0;
    $rating_count = 0;
    
    foreach ($performance_reviews as $review) {
        // Only count performance reviews (not goals or recognitions)
        if (!empty($review['performance_rating']) || !empty($review['goals_achievement']) || !empty($review['strengths'])) {
            $performance_stats['total_reviews']++;
        }
        
        if (!empty($review['performance_rating'])) {
            $total_rating += $review['performance_rating'];
            $rating_count++;
            
            // Count rating distribution
            $rounded_rating = round($review['performance_rating']);
            if ($rounded_rating >= 1 && $rounded_rating <= 10) {
                $performance_stats['rating_distribution'][$rounded_rating]++;
            }
        }
        
        // Department statistics
        $dept = $review['department'];
        if (!isset($performance_stats['department_stats'][$dept])) {
            $performance_stats['department_stats'][$dept] = array(
                'count' => 0,
                'total_rating' => 0,
                'avg_rating' => 0
            );
        }
        
        if (!empty($review['performance_rating']) || !empty($review['goals_achievement']) || !empty($review['strengths'])) {
            $performance_stats['department_stats'][$dept]['count']++;
        }
        
        if (!empty($review['performance_rating'])) {
            $performance_stats['department_stats'][$dept]['total_rating'] += $review['performance_rating'];
        }
    }
    
    // Calculate average rating
    if ($rating_count > 0) {
        $performance_stats['avg_rating'] = round($total_rating / $rating_count, 2);
    }
    
    // Calculate department averages
    foreach ($performance_stats['department_stats'] as $dept => $stats) {
        if ($stats['count'] > 0 && $stats['total_rating'] > 0) {
            $performance_stats['department_stats'][$dept]['avg_rating'] = 
                round($stats['total_rating'] / $stats['count'], 2);
        }
    }
}
// Get top performers (rating >= 8)
$top_performers = array();
foreach ($performance_reviews as $review) {
    if (!empty($review['performance_rating']) && $review['performance_rating'] >= 8) {
        $top_performers[] = $review;
    }
}
// Get employees needing improvement (rating <= 5)
$needs_improvement = array();
foreach ($performance_reviews as $review) {
    if (!empty($review['performance_rating']) && $review['performance_rating'] <= 5) {
        $needs_improvement[] = $review;
    }
}
// Get employee performance history for detailed view
$employee_performance_history = array();
if ($active_section == 'employee' && isset($_GET['employee_id']) && !empty($_GET['employee_id'])) {
    $employee_id = $_GET['employee_id'];
    $period = isset($_GET['period']) ? $_GET['period'] : 'current_year';
    
    // Build date filter based on period
    $date_filter = "";
    $current_year = date('Y');
    $last_year = $current_year - 1;
    
    switch ($period) {
        case 'current_year':
            $date_filter = "AND YEAR(pr.review_date) = $current_year";
            break;
        case 'last_year':
            $date_filter = "AND YEAR(pr.review_date) = $last_year";
            break;
        case 'all_time':
        default:
            // No date filter for all time
            break;
    }
    
    $history_sql = "SELECT pr.*, CONCAT(r.first_name, ' ', r.last_name) as reviewer_name 
                   FROM performance_reviews pr 
                   LEFT JOIN employees r ON pr.reviewer_id = r.id 
                   WHERE pr.employee_id = $employee_id $date_filter
                   ORDER BY pr.review_date DESC";
    $history_result = $conn->query($history_sql);
    if ($history_result->num_rows > 0) {
        while ($row = $history_result->fetch_assoc()) {
            $employee_performance_history[] = $row;
        }
    }
}
// Get analytics data
$analytics_data = array();
if ($active_section == 'analytics') {
    $period = isset($_GET['period']) ? $_GET['period'] : 'current_quarter';
    $department = isset($_GET['department']) ? $_GET['department'] : '';
    
    // Build date filter based on period
    $date_filter = "";
    $current_date = date('Y-m-d');
    $current_year = date('Y');
    $current_quarter = ceil(date('n') / 3);
    $last_quarter = $current_quarter == 1 ? 4 : $current_quarter - 1;
    $last_quarter_year = $current_quarter == 1 ? $current_year - 1 : $current_year;
    
    switch ($period) {
        case 'current_quarter':
            $quarter_start = date('Y-m-d', mktime(0, 0, 0, ($current_quarter - 1) * 3 + 1, 1, $current_year));
            $date_filter = "AND pr.review_date BETWEEN '$quarter_start' AND '$current_date'";
            break;
        case 'last_quarter':
            $quarter_start = date('Y-m-d', mktime(0, 0, 0, ($last_quarter - 1) * 3 + 1, 1, $last_quarter_year));
            $quarter_end = date('Y-m-d', mktime(0, 0, 0, $last_quarter * 3, 31, $last_quarter_year));
            $date_filter = "AND pr.review_date BETWEEN '$quarter_start' AND '$quarter_end'";
            break;
        case 'current_year':
            $date_filter = "AND YEAR(pr.review_date) = $current_year";
            break;
        case 'last_year':
            $date_filter = "AND YEAR(pr.review_date) = " . ($current_year - 1);
            break;
    }
    
    // Build department filter
    $dept_filter = "";
    if (!empty($department)) {
        $dept_filter = "AND e.department = '" . $conn->real_escape_string($department) . "'";
    }
    
    // Get performance trends
    $trends_sql = "SELECT YEAR(pr.review_date) as year, MONTH(pr.review_date) as month, 
                  AVG(pr.performance_rating) as avg_rating, COUNT(*) as review_count
                  FROM performance_reviews pr
                  JOIN employees e ON pr.employee_id = e.id
                  WHERE pr.performance_rating IS NOT NULL $date_filter $dept_filter
                  GROUP BY YEAR(pr.review_date), MONTH(pr.review_date)
                  ORDER BY year, month";
    $trends_result = $conn->query($trends_sql);
    if ($trends_result->num_rows > 0) {
        while ($row = $trends_result->fetch_assoc()) {
            $analytics_data['trends'][] = $row;
        }
    }
    
    // Get performance distribution
    $dist_sql = "SELECT 
                SUM(CASE WHEN pr.performance_rating >= 8 THEN 1 ELSE 0 END) as exceeds,
                SUM(CASE WHEN pr.performance_rating >= 6 AND pr.performance_rating < 8 THEN 1 ELSE 0 END) as meets,
                SUM(CASE WHEN pr.performance_rating < 6 THEN 1 ELSE 0 END) as needs_improvement
                FROM performance_reviews pr
                JOIN employees e ON pr.employee_id = e.id
                WHERE pr.performance_rating IS NOT NULL $date_filter $dept_filter";
    $dist_result = $conn->query($dist_sql);
    if ($dist_result->num_rows > 0) {
        $analytics_data['distribution'] = $dist_result->fetch_assoc();
    }
    
    // Get performance metrics
    $metrics_sql = "SELECT 
                  AVG(pr.performance_rating) as avg_rating,
                  COUNT(*) as total_reviews,
                  SUM(CASE WHEN pr.performance_rating >= 8 THEN 1 ELSE 0 END) as top_performers,
                  SUM(CASE WHEN pr.performance_rating <= 5 THEN 1 ELSE 0 END) as needs_improvement
                  FROM performance_reviews pr
                  JOIN employees e ON pr.employee_id = e.id
                  WHERE pr.performance_rating IS NOT NULL $date_filter $dept_filter";
    $metrics_result = $conn->query($metrics_sql);
    if ($metrics_result->num_rows > 0) {
        $analytics_data['metrics'] = $metrics_result->fetch_assoc();
    }
    
    // Get goals progress metrics
    $goals_sql = "SELECT 
                  AVG(pr.goal_progress) as avg_goal_progress,
                  COUNT(*) as total_goals,
                  SUM(CASE WHEN pr.goal_progress = 100 THEN 1 ELSE 0 END) as completed_goals,
                  SUM(CASE WHEN pr.goal_progress < 50 THEN 1 ELSE 0 END) as goals_needing_attention
                  FROM performance_reviews pr
                  JOIN employees e ON pr.employee_id = e.id
                  WHERE pr.goal_progress IS NOT NULL $date_filter $dept_filter";
    $goals_result = $conn->query($goals_sql);
    if ($goals_result->num_rows > 0) {
        $analytics_data['goals'] = $goals_result->fetch_assoc();
    }
    
    // Get recognition metrics
    $recognition_sql = "SELECT 
                  COUNT(*) as total_recognitions,
                  pr.recognition_type,
                  COUNT(DISTINCT pr.employee_id) as recognized_employees
                  FROM performance_reviews pr
                  JOIN employees e ON pr.employee_id = e.id
                  WHERE pr.recognition_type IS NOT NULL $date_filter $dept_filter
                  GROUP BY pr.recognition_type";
    $recognition_result = $conn->query($recognition_sql);
    if ($recognition_result->num_rows > 0) {
        $analytics_data['recognition'] = array();
        while ($row = $recognition_result->fetch_assoc()) {
            $analytics_data['recognition'][] = $row;
        }
    }
}
// Fetch goals data
$goals_data = array();
if ($active_section == 'goals') {
    $employee_filter = isset($_GET['employee_id']) ? "AND pr.employee_id = " . intval($_GET['employee_id']) : "";
    // FIXED: Removed goal_category filter since it doesn't exist in the table
    $category_filter = ""; // This was causing issues since goal_category doesn't exist
    
    $goals_sql = "SELECT pr.*, CONCAT(e.first_name, ' ', e.last_name) as employee_name, e.department
                 FROM performance_reviews pr
                 JOIN employees e ON pr.employee_id = e.id
                 WHERE pr.goal_description IS NOT NULL $employee_filter $category_filter
                 ORDER BY pr.goal_target_date ASC";
    $goals_result = $conn->query($goals_sql);
    if ($goals_result->num_rows > 0) {
        while ($row = $goals_result->fetch_assoc()) {
            $goals_data[] = $row;
        }
    }
}
// Fetch recognition data
$recognition_data = array();
if ($active_section == 'recognition') {
    $employee_filter = isset($_GET['employee_id']) ? "AND pr.employee_id = " . intval($_GET['employee_id']) : "";
    $type_filter = isset($_GET['type']) ? "AND pr.recognition_type = '" . $conn->real_escape_string($_GET['type']) . "'" : "";
    
   $recognition_sql = "SELECT pr.*, e.name as employee_name, e.department,
                    rg.name as recognition_given_by_name
                    FROM performance_reviews pr
                    JOIN employees e ON pr.employee_id = e.id
                    LEFT JOIN employees rg ON pr.recognition_given_by = rg.id
                    WHERE pr.recognition_type IS NOT NULL $employee_filter $type_filter
                    ORDER BY pr.recognition_date DESC";
    $recognition_result = $conn->query($recognition_sql);
    if ($recognition_result->num_rows > 0) {
        while ($row = $recognition_result->fetch_assoc()) {
            $recognition_data[] = $row;
        }
    }
}
// Fetch reports data
$reports_data = array();
if ($active_section == 'reports') {
   $reports_sql = "SELECT pr.*, e.name as employee_name, e.department,
               rb.name as report_generated_by_name
               FROM performance_reviews pr
               LEFT JOIN employees e ON pr.employee_id = e.id
               LEFT JOIN employees rb ON pr.report_generated_by = rb.id
               WHERE pr.report_category IS NOT NULL
               ORDER BY pr.report_generated_date DESC";
    $reports_result = $conn->query($reports_sql);
    if ($reports_result->num_rows > 0) {
        while ($row = $reports_result->fetch_assoc()) {
            $reports_data[] = $row;
        }
    }
}
$conn->close();
?>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Performance Management System - Buymeabook</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #1a2a6c 0%, #b21f1f 50%, #fdbb2d 100%);
            min-height: 100vh;
            color: #333;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
        }
        
        .logo {
            width: 200px;
            height: auto;
            border-radius: 10px;
        }
        
        .nav-links {
            display: flex;
            gap: 15px;
        }
        
        .nav-link {
            color: #1a2a6c;
            text-decoration: none;
            font-weight: 600;
            padding: 10px 15px;
            border-radius: 50px;
            transition: all 0.3s;
        }
        
        .nav-link:hover, .nav-link.active {
            background: #1a2a6c;
            color: white;
        }
        
        .dashboard {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .sidebar {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
            height: fit-content;
        }
        
        .sidebar-title {
            font-size: 1.3rem;
            margin-bottom: 20px;
            color: #1a2a6c;
            padding-bottom: 10px;
            border-bottom: 2px solid #eee;
        }
        
        .sidebar-menu {
            list-style: none;
        }
        
        .sidebar-menu li {
            margin-bottom: 10px;
        }
        
        .sidebar-menu a {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 15px;
            color: #444;
            text-decoration: none;
            border-radius: 8px;
            transition: all 0.3s;
        }
        
        .sidebar-menu a:hover, .sidebar-menu a.active {
            background: #1a2a6c;
            color: white;
        }
        
        .main-content {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
        }
        
        .section-title {
            font-size: 1.5rem;
            margin-bottom: 20px;
            color: #1a2a6c;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
            text-align: center;
        }
        
        .stat-icon {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: #1a2a6c;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 20px;
            margin: 0 auto 15px;
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: #1a2a6c;
            margin-bottom: 5px;
        }
        
        .stat-label {
            color: #666;
            font-size: 0.9rem;
        }
        
        .analytics-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .analytics-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
        }
        
        .analytics-title {
            font-size: 1.2rem;
            margin-bottom: 20px;
            color: #1a2a6c;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }
        
        .form-section {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
        }
        
        .form-title {
            font-size: 1.2rem;
            margin-bottom: 20px;
            color: #1a2a6c;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #444;
        }
        
        .form-control {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border 0.3s;
        }
        
        .form-control:focus {
            border-color: #1a2a6c;
            outline: none;
        }
        
        .btn {
            padding: 12px 20px;
            background: #1a2a6c;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn:hover {
            background: #15225a;
            transform: translateY(-2px);
        }
        
        .btn-secondary {
            background: #6c757d;
        }
        
        .btn-secondary:hover {
            background: #5a6268;
        }
        
        .data-section {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .data-table th, .data-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        
        .data-table th {
            background: #f8f9fa;
            color: #1a2a6c;
            font-weight: 600;
        }
        
        .data-table tr:hover {
            background: #f8f9fa;
        }
        
        .badge {
            padding: 5px 10px;
            border-radius: 50px;
            font-size: 0.8rem;
            font-weight: 500;
        }
        
        .badge-success {
            background: #d4edda;
            color: #155724;
        }
        
        .badge-warning {
            background: #fff3cd;
            color: #856404;
        }
        
        .badge-danger {
            background: #f8d7da;
            color: #721c24;
        }
        
        .badge-info {
            background: #d1ecf1;
            color: #0c5460;
        }
        
        .badge-primary {
            background: #cce5ff;
            color: #004085;
        }
        
        .message {
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 8px;
            text-align: center;
            font-weight: 500;
        }
        
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 20px;
            border-bottom: 1px solid #eee;
        }
        
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border-radius: 5px 5px 0 0;
            transition: all 0.3s;
        }
        
        .tab.active {
            background: #1a2a6c;
            color: white;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .performance-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }
        
        .performance-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            border-left: 4px solid #1a2a6c;
        }
        
        .performance-card h4 {
            margin-bottom: 10px;
            color: #1a2a6c;
        }
        
        .performance-card p {
            margin-bottom: 5px;
            color: #666;
        }
        
        .goal-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
        }
        
        .goal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .goal-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #1a2a6c;
        }
        
        .goal-progress {
            margin-bottom: 15px;
        }
        
        .progress-bar {
            height: 10px;
            background: #e9ecef;
            border-radius: 5px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: #1a2a6c;
            border-radius: 5px;
        }
        
        .recognition-item {
            display: flex;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #eee;
        }
        
        .recognition-item:last-child {
            border-bottom: none;
        }
        
        .recognition-icon {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: #f8f9fa;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            font-size: 20px;
            color: #1a2a6c;
        }
        
        .recognition-content {
            flex: 1;
        }
        
        .recognition-title {
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .recognition-date {
            font-size: 0.8rem;
            color: #666;
        }
        
        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }
        
        .settings-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
        }
        
        .settings-title {
            font-size: 1.1rem;
            margin-bottom: 15px;
            color: #1a2a6c;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .filter-section {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            overflow: auto;
        }
        
        .modal-content {
            background-color: #fff;
            margin: 5% auto;
            padding: 20px;
            border-radius: 15px;
            width: 90%;
            max-width: 1200px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
            animation: modalopen 0.4s;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        @keyframes modalopen {
            from {opacity: 0; transform: translateY(-50px);}
            to {opacity: 1; transform: translateY(0);}
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }
        
        .modal-title {
            font-size: 1.5rem;
            color: #1a2a6c;
            font-weight: 600;
        }
        
        .close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s;
        }
        
        .close:hover {
            color: #000;
        }
        
        .modal-body {
            margin-bottom: 20px;
        }
        
        .detail-section {
            margin-bottom: 20px;
        }
        
        .detail-section h4 {
            color: #1a2a6c;
            margin-bottom: 10px;
            font-size: 1.1rem;
        }
        
        .detail-section p {
            line-height: 1.6;
            color: #555;
        }
        
        .detail-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .detail-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border-left: 3px solid #1a2a6c;
        }
        
        .detail-label {
            font-weight: 600;
            color: #1a2a6c;
            margin-bottom: 5px;
        }
        
        .detail-value {
            color: #555;
        }
        
        .report-content {
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .report-content h1, .report-content h2, .report-content h3 {
            color: #1a2a6c;
            margin-bottom: 15px;
        }
        
        .report-content table {
            margin: 20px 0;
        }
        
        .report-content th, .report-content td {
            padding: 10px;
            border: 1px solid #ddd;
        }
        
        .report-content th {
            background-color: #f2f2f2;
            font-weight: bold;
        }
        
        @media (max-width: 1024px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
            
            .stats-grid, .analytics-grid {
                grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            }
        }
        
        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }
            
            .nav-links {
                flex-wrap: wrap;
                justify-content: center;
            }
            
            .form-grid, .analytics-grid {
                grid-template-columns: 1fr;
            }
            
            .performance-list {
                grid-template-columns: 1fr;
            }
            
            .modal-content {
                width: 95%;
                margin: 10% auto;
                padding: 15px;
            }
            
            .detail-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <img src="https://ik.imagekit.io/nuvq7aygp/BMB_Logo.jpg" alt="BMB Logo" class="logo">
            <div class="nav-links">
                <a href="start.php" class="nav-link"><i class="fas fa-home"></i> Home</a>
                <a href="status.php" class="nav-link"><i class="fas fa-stream"></i> Status Updates</a>
                <a href="hrms.php" class="nav-link"><i class="fas fa-users-cog"></i> HR Management</a>
                <a href="performance_management.php" class="nav-link active"><i class="fas fa-chart-line"></i> Performance Management</a>
                <a href="uploader.html" class="nav-link"><i class="fas fa-folder"></i> Manage Files</a>
                <a href="logout.php" class="nav-link"><i class="fas fa-sign-out-alt"></i> Logout</a>
            </div>
        </div>
        
        <?php if (!empty($message)): ?>
            <div class="message <?php echo $message_type; ?>">
                <?php echo $message; ?>
            </div>
        <?php endif; ?>
        
        <div class="dashboard">
            <div class="sidebar">
                <h2 class="sidebar-title">Performance Dashboard</h2>
                <ul class="sidebar-menu">
                    <li><a href="performance_management.php?section=overview" class="<?php echo $active_section == 'overview' ? 'active' : ''; ?>"><i class="fas fa-tachometer-alt"></i> Overview</a></li>
                    <li><a href="performance_management.php?section=employee" class="<?php echo $active_section == 'employee' ? 'active' : ''; ?>"><i class="fas fa-user-chart"></i> Employee Performance</a></li>
                    <li><a href="performance_management.php?section=analytics" class="<?php echo $active_section == 'analytics' ? 'active' : ''; ?>"><i class="fas fa-chart-bar"></i> Analytics</a></li>
                    <li><a href="performance_management.php?section=goals" class="<?php echo $active_section == 'goals' ? 'active' : ''; ?>"><i class="fas fa-bullseye"></i> Goals & OKRs</a></li>
                    <li><a href="performance_management.php?section=recognition" class="<?php echo $active_section == 'recognition' ? 'active' : ''; ?>"><i class="fas fa-award"></i> Recognition</a></li>
                    <li><a href="performance_management.php?section=reports" class="<?php echo $active_section == 'reports' ? 'active' : ''; ?>"><i class="fas fa-chart-pie"></i> Reports</a></li>
                    <li><a href="performance_management.php?section=settings" class="<?php echo $active_section == 'settings' ? 'active' : ''; ?>"><i class="fas fa-cog"></i> Settings</a></li>
                </ul>
            </div>
            
            <div class="main-content">
                <?php if ($active_section == 'overview'): ?>
                    <h2 class="section-title"><i class="fas fa-chart-line"></i> Performance Management System</h2>
                    
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-icon">
                                <i class="fas fa-clipboard-check"></i>
                            </div>
                            <div class="stat-value"><?php echo $performance_stats['total_reviews']; ?></div>
                            <div class="stat-label">Total Reviews</div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-icon">
                                <i class="fas fa-star"></i>
                            </div>
                            <div class="stat-value"><?php echo $performance_stats['avg_rating']; ?>/10</div>
                            <div class="stat-label">Average Rating</div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-icon">
                                <i class="fas fa-trophy"></i>
                            </div>
                            <div class="stat-value"><?php echo count($top_performers); ?></div>
                            <div class="stat-label">Top Performers</div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-icon">
                                <i class="fas fa-exclamation-circle"></i>
                            </div>
                            <div class="stat-value"><?php echo count($needs_improvement); ?></div>
                            <div class="stat-label">Needs Improvement</div>
                        </div>
                    </div>
                    
                    <div class="analytics-grid">
                        <div class="analytics-card">
                            <h3 class="analytics-title"><i class="fas fa-chart-bar"></i> Rating Distribution</h3>
                            <div class="chart-container">
                                <canvas id="ratingChart"></canvas>
                            </div>
                        </div>
                        
                        <div class="analytics-card">
                            <h3 class="analytics-title"><i class="fas fa-chart-pie"></i> Department Performance</h3>
                            <div class="chart-container">
                                <canvas id="departmentChart"></canvas>
                            </div>
                        </div>
                    </div>
                    
                    <div class="tabs">
                        <div class="tab active" data-tab="reviews">Performance Reviews</div>
                        <div class="tab" data-tab="analytics">Advanced Analytics</div>
                        <div class="tab" data-tab="top">Top Performers</div>
                        <div class="tab" data-tab="improvement">Improvement Needed</div>
                    </div>
                    
                    <div class="tab-content active" id="reviews-tab">
                        <div class="form-section">
                            <h3 class="form-title"><i class="fas fa-chart-line"></i> Record Performance Review</h3>
                            <form method="POST" id="performance-form">
                                <div class="form-grid">
                                    <div class="form-group">
                                        <label for="perf_employee_id">Employee</label>
                                        <select id="perf_employee_id" name="employee_id" class="form-control" required>
                                            <option value="">Select Employee</option>
                                            <?php foreach ($employees as $employee): ?>
                                                <option value="<?php echo $employee['id']; ?>">
                                                    <?php echo htmlspecialchars($employee['name'] . ' (' . $employee['department'] . ')'); ?>
                                                </option>
                                            <?php endforeach; ?>
                                        </select>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label for="review_date">Review Date</label>
                                        <input type="date" id="review_date" name="review_date" class="form-control" value="<?php echo date('Y-m-d'); ?>" required>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label for="reviewer_id">Reviewer</label>
                                        <select id="reviewer_id" name="reviewer_id" class="form-control" required>
                                            <option value="">Select Reviewer</option>
                                            <?php foreach ($employees as $employee): ?>
                                                <option value="<?php echo $employee['id']; ?>">
                                                    <?php echo htmlspecialchars($employee['name'] . ' (' . $employee['department'] . ')'); ?>
                                                </option>
                                            <?php endforeach; ?>
                                        </select>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label for="performance_rating">Performance Rating (1-10)</label>
                                        <input type="number" id="performance_rating" name="performance_rating" class="form-control" min="1" max="10" step="0.1">
                                    </div>
                                    
                                    <div class="form-group">
                                        <label for="next_review_date">Next Review Date</label>
                                        <input type="date" id="next_review_date" name="next_review_date" class="form-control">
                                    </div>
                                    
                                    <div class="form-group" style="grid-column: 1 / -1;">
                                        <label for="goals_achievement">Goals Achievement</label>
                                        <textarea id="goals_achievement" name="goals_achievement" class="form-control" rows="3"></textarea>
                                    </div>
                                    
                                    <div class="form-group" style="grid-column: 1 / -1;">
                                        <label for="strengths">Strengths</label>
                                        <textarea id="strengths" name="strengths" class="form-control" rows="3"></textarea>
                                    </div>
                                    
                                    <div class="form-group" style="grid-column: 1 / -1;">
                                        <label for="areas_for_improvement">Areas for Improvement</label>
                                        <textarea id="areas_for_improvement" name="areas_for_improvement" class="form-control" rows="3"></textarea>
                                    </div>
                                    
                                    <div class="form-group" style="grid-column: 1 / -1;">
                                        <label for="recommendations">Recommendations</label>
                                        <textarea id="recommendations" name="recommendations" class="form-control" rows="3"></textarea>
                                    </div>
                                </div>
                                
                                <button type="submit" name="add_performance" class="btn"><i class="fas fa-save"></i> Save Performance Review</button>
                            </form>
                        </div>
                        
                        <div class="data-section">
                            <h3 class="form-title"><i class="fas fa-history"></i> Recent Performance Reviews</h3>
                            <div style="overflow-x: auto;">
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th>Employee</th>
                                            <th>Department</th>
                                            <th>Review Date</th>
                                            <th>Reviewer</th>
                                            <th>Rating</th>
                                            <th>Next Review</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                    <?php if (count($performance_reviews) > 0): ?>
                                        <?php foreach ($performance_reviews as $review): ?>
                                            <?php if (!empty($review['performance_rating']) || !empty($review['goals_achievement']) || !empty($review['strengths'])): ?>
                                            <tr>
                                                <td><?php echo htmlspecialchars($review['employee_name']); ?></td>
                                                <td><?php echo htmlspecialchars($review['department']); ?></td>
                                                <td><?php echo date('M j, Y', strtotime($review['review_date'])); ?></td>
                                                <td><?php echo htmlspecialchars($review['reviewer_name']); ?></td>
                                                <td>
                                                    <?php if (!empty($review['performance_rating'])): ?>
                                                        <span class="badge 
                                                            <?php 
                                                            if ($review['performance_rating'] >= 8) echo 'badge-success';
                                                            elseif ($review['performance_rating'] >= 5) echo 'badge-warning';
                                                            else echo 'badge-danger';
                                                            ?>">
                                                            <?php echo $review['performance_rating']; ?>/10
                                                        </span>
                                                    <?php else: ?>
                                                        <span>Not rated</span>
                                                    <?php endif; ?>
                                                </td>
                                                <td><?php echo !empty($review['next_review_date']) ? date('M j, Y', strtotime($review['next_review_date'])) : '-'; ?></td>
                                                <td>
                                                    <button class="btn btn-secondary view-performance" data-id="<?php echo $review['id']; ?>" style="padding: 5px 10px; font-size: 14px;">
                                                        <i class="fas fa-eye"></i> View Details
                                                    </button>
                                                </td>
                                            </tr>
                                            <?php endif; ?>
                                        <?php endforeach; ?>
                                    <?php else: ?>
                                        <tr>
                                            <td colspan="7" style="text-align: center;">No performance reviews found.</td>
                                        </tr>
                                    <?php endif; ?>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <div class="tab-content" id="analytics-tab">
                        <div class="data-section">
                            <h3 class="form-title"><i class="fas fa-chart-area"></i> Performance Trends</h3>
                            <div class="chart-container">
                                <canvas id="trendChart"></canvas>
                            </div>
                        </div>
                        
                        <div class="data-section">
                            <h3 class="form-title"><i class="fas fa-table"></i> Department Performance Summary</h3>
                            <div style="overflow-x: auto;">
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th>Department</th>
                                            <th>Number of Reviews</th>
                                            <th>Average Rating</th>
                                            <th>Top Performers</th>
                                            <th>Needs Improvement</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                    <?php if (count($performance_stats['department_stats']) > 0): ?>
                                        <?php foreach ($performance_stats['department_stats'] as $dept => $stats): ?>
                                            <tr>
                                                <td><?php echo htmlspecialchars($dept); ?></td>
                                                <td><?php echo $stats['count']; ?></td>
                                                <td>
                                                    <?php if (!empty($stats['avg_rating'])): ?>
                                                        <span class="badge 
                                                            <?php 
                                                            if ($stats['avg_rating'] >= 8) echo 'badge-success';
                                                            elseif ($stats['avg_rating'] >= 5) echo 'badge-warning';
                                                            else echo 'badge-danger';
                                                            ?>">
                                                            <?php echo $stats['avg_rating']; ?>/10
                                                        </span>
                                                    <?php else: ?>
                                                        <span>No ratings</span>
                                                    <?php endif; ?>
                                                </td>
                                                <td>
                                                    <?php
                                                    $dept_top = 0;
                                                    foreach ($performance_reviews as $review) {
                                                        if ($review['department'] === $dept && !empty($review['performance_rating']) && $review['performance_rating'] >= 8) {
                                                            $dept_top++;
                                                        }
                                                    }
                                                    echo $dept_top;
                                                    ?>
                                                </td>
                                                <td>
                                                    <?php
                                                    $dept_low = 0;
                                                    foreach ($performance_reviews as $review) {
                                                        if ($review['department'] === $dept && !empty($review['performance_rating']) && $review['performance_rating'] <= 5) {
                                                            $dept_low++;
                                                        }
                                                    }
                                                    echo $dept_low;
                                                    ?>
                                                </td>
                                            </tr>
                                        <?php endforeach; ?>
                                    <?php else: ?>
                                        <tr>
                                            <td colspan="5" style="text-align: center;">No department data available.</td>
                                        </tr>
                                    <?php endif; ?>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <div class="tab-content" id="top-tab">
                        <div class="data-section">
                            <h3 class="form-title"><i class="fas fa-trophy"></i> Top Performers (Rating â¥ 8)</h3>
                            <div class="performance-list">
                                <?php if (count($top_performers) > 0): ?>
                                    <?php foreach ($top_performers as $performer): ?>
                                        <div class="performance-card">
                                            <h4><?php echo htmlspecialchars($performer['employee_name']); ?></h4>
                                            <p><strong>Department:</strong> <?php echo htmlspecialchars($performer['department']); ?></p>
                                            <p><strong>Rating:</strong> <?php echo $performer['performance_rating']; ?>/10</p>
                                            <p><strong>Review Date:</strong> <?php echo date('M j, Y', strtotime($performer['review_date'])); ?></p>
                                            <p><strong>Reviewed By:</strong> <?php echo htmlspecialchars($performer['reviewer_name']); ?></p>
                                            <?php if (!empty($performer['strengths'])): ?>
                                                <p><strong>Strengths:</strong> <?php echo substr(htmlspecialchars($performer['strengths']), 0, 100); ?>...</p>
                                            <?php endif; ?>
                                        </div>
                                    <?php endforeach; ?>
                                <?php else: ?>
                                    <p style="text-align: center; grid-column: 1 / -1;">No top performers found.</p>
                                <?php endif; ?>
                            </div>
                        </div>
                    </div>
                    
                    <div class="tab-content" id="improvement-tab">
                        <div class="data-section">
                            <h3 class="form-title"><i class="fas fa-exclamation-triangle"></i> Employees Needing Improvement (Rating â¤ 5)</h3>
                            <div class="performance-list">
                                <?php if (count($needs_improvement) > 0): ?>
                                    <?php foreach ($needs_improvement as $employee): ?>
                                        <div class="performance-card">
                                            <h4><?php echo htmlspecialchars($employee['employee_name']); ?></h4>
                                            <p><strong>Department:</strong> <?php echo htmlspecialchars($employee['department']); ?></p>
                                            <p><strong>Rating:</strong> <?php echo $employee['performance_rating']; ?>/10</p>
                                            <p><strong>Review Date:</strong> <?php echo date('M j, Y', strtotime($employee['review_date'])); ?></p>
                                            <p><strong>Reviewed By:</strong> <?php echo htmlspecialchars($employee['reviewer_name']); ?></p>
                                            <?php if (!empty($employee['areas_for_improvement'])): ?>
                                                <p><strong>Areas for Improvement:</strong> <?php echo substr(htmlspecialchars($employee['areas_for_improvement']), 0, 100); ?>...</p>
                                            <?php endif; ?>
                                            <?php if (!empty($employee['recommendations'])): ?>
                                                <p><strong>Recommendations:</strong> <?php echo substr(htmlspecialchars($employee['recommendations']), 0, 100); ?>...</p>
                                            <?php endif; ?>
                                        </div>
                                    <?php endforeach; ?>
                                <?php else: ?>
                                    <p style="text-align: center; grid-column: 1 / -1;">No employees needing improvement found.</p>
                                <?php endif; ?>
                            </div>
                        </div>
                    </div>
                <?php endif; ?>
                
                <?php if ($active_section == 'employee'): ?>
                    <h2 class="section-title"><i class="fas fa-user-chart"></i> Employee Performance</h2>
                    
                    <div class="form-section">
                        <h3 class="form-title"><i class="fas fa-user"></i> Select Employee</h3>
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="perf_employee_select">Employee</label>
                                <select id="perf_employee_select" class="form-control">
                                    <option value="">Select Employee</option>
                                    <?php foreach ($employees as $employee): ?>
                                        <option value="<?php echo $employee['id']; ?>" <?php if(isset($_GET['employee_id']) && $_GET['employee_id'] == $employee['id']) echo 'selected'; ?>>
                                            <?php echo htmlspecialchars($employee['name'] . ' (' . $employee['department'] . ')'); ?>
                                        </option>
                                    <?php endforeach; ?>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label for="perf_period">Period</label>
                                <select id="perf_period" class="form-control">
                                    <option value="current_year" <?php if(isset($_GET['period']) && $_GET['period'] == 'current_year') echo 'selected'; ?>>Current Year</option>
                                    <option value="last_year" <?php if(isset($_GET['period']) && $_GET['period'] == 'last_year') echo 'selected'; ?>>Last Year</option>
                                    <option value="all_time" <?php if(isset($_GET['period']) && $_GET['period'] == 'all_time') echo 'selected'; ?>>All Time</option>
                                </select>
                            </div>
                            
                            <div class="form-group" style="display: flex; align-items: flex-end;">
                                <button class="btn" id="generateEmployeePerf"><i class="fas fa-user-chart"></i> Generate Report</button>
                            </div>
                        </div>
                    </div>
                    
                    <?php if (count($employee_performance_history) > 0): ?>
                        <div class="stats-grid" id="employeePerfStats">
                            <?php
                            // Calculate employee stats
                            $total_reviews = count($employee_performance_history);
                            $total_rating = 0;
                            $rating_count = 0;
                            
                            foreach ($employee_performance_history as $review) {
                                if (!empty($review['performance_rating'])) {
                                    $total_rating += $review['performance_rating'];
                                    $rating_count++;
                                }
                            }
                            
                            $avg_rating = $rating_count > 0 ? round($total_rating / $rating_count, 2) : 0;
                            
                            // Calculate rating trend (compare first and last review)
                            $first_rating = 0;
                            $last_rating = 0;
                            if ($rating_count >= 2) {
                                $first_review = end($employee_performance_history);
                                $last_review = reset($employee_performance_history);
                                
                                if (!empty($first_review['performance_rating'])) {
                                    $first_rating = $first_review['performance_rating'];
                                }
                                
                                if (!empty($last_review['performance_rating'])) {
                                    $last_rating = $last_review['performance_rating'];
                                }
                            }
                            
                            $rating_trend = 0;
                            if ($first_rating > 0) {
                                $rating_trend = round((($last_rating - $first_rating) / $first_rating) * 100);
                            }
                            
                            $last_review_date = !empty($employee_performance_history[0]['review_date']) ? 
                                date('M j, Y', strtotime($employee_performance_history[0]['review_date'])) : '-';
                            ?>
                            
                            <div class="stat-card">
                                <div class="stat-icon">
                                    <i class="fas fa-clipboard-check"></i>
                                </div>
                                <div class="stat-value"><?php echo $total_reviews; ?></div>
                                <div class="stat-label">Total Reviews</div>
                            </div>
                            
                            <div class="stat-card">
                                <div class="stat-icon">
                                    <i class="fas fa-star"></i>
                                </div>
                                <div class="stat-value"><?php echo $avg_rating; ?></div>
                                <div class="stat-label">Average Rating</div>
                            </div>
                            
                            <div class="stat-card">
                                <div class="stat-icon">
                                    <i class="fas fa-chart-line"></i>
                                </div>
                                <div class="stat-value"><?php echo ($rating_trend >= 0 ? '+' : '') . $rating_trend; ?>%</div>
                                <div class="stat-label">Rating Trend</div>
                            </div>
                            
                            <div class="stat-card">
                                <div class="stat-icon">
                                    <i class="fas fa-calendar-alt"></i>
                                </div>
                                <div class="stat-value"><?php echo $last_review_date; ?></div>
                                <div class="stat-label">Last Review</div>
                            </div>
                        </div>
                        
                        <div class="data-section" id="employeePerfDetails">
                            <h3 class="form-title"><i class="fas fa-history"></i> Performance History</h3>
                            <div class="chart-container">
                                <canvas id="employeePerfChart"></canvas>
                            </div>
                            
                            <div style="overflow-x: auto; margin-top: 20px;">
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th>Review Date</th>
                                            <th>Reviewer</th>
                                            <th>Rating</th>
                                            <th>Goals Achievement</th>
                                            <th>Strengths</th>
                                            <th>Areas for Improvement</th>
                                        </tr>
                                    </thead>
                                    <tbody id="employeePerfTableBody">
                                        <?php foreach ($employee_performance_history as $review): ?>
                                            <tr>
                                                <td><?php echo date('M j, Y', strtotime($review['review_date'])); ?></td>
                                                <td><?php echo htmlspecialchars($review['reviewer_name']); ?></td>
                                                <td>
                                                    <?php if (!empty($review['performance_rating'])): ?>
                                                        <span class="badge 
                                                            <?php 
                                                            if ($review['performance_rating'] >= 8) echo 'badge-success';
                                                            elseif ($review['performance_rating'] >= 5) echo 'badge-warning';
                                                            else echo 'badge-danger';
                                                            ?>">
                                                            <?php echo $review['performance_rating']; ?>/10
                                                        </span>
                                                    <?php else: ?>
                                                        <span>Not rated</span>
                                                    <?php endif; ?>
                                                </td>
                                                <td><?php echo !empty($review['goals_achievement']) ? substr(htmlspecialchars($review['goals_achievement']), 0, 50) . '...' : '-'; ?></td>
                                                <td><?php echo !empty($review['strengths']) ? substr(htmlspecialchars($review['strengths']), 0, 50) . '...' : '-'; ?></td>
                                                <td><?php echo !empty($review['areas_for_improvement']) ? substr(htmlspecialchars($review['areas_for_improvement']), 0, 50) . '...' : '-'; ?></td>
                                            </tr>
                                        <?php endforeach; ?>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    <?php endif; ?>
                <?php endif; ?>
                
                <?php if ($active_section == 'analytics'): ?>
                    <h2 class="section-title"><i class="fas fa-chart-bar"></i> Performance Analytics</h2>
                    
                    <div class="form-section">
                        <h3 class="form-title"><i class="fas fa-filter"></i> Select Analysis Parameters</h3>
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="analytics_period">Period</label>
                                <select id="analytics_period" class="form-control">
                                    <option value="current_quarter" <?php if(isset($_GET['period']) && $_GET['period'] == 'current_quarter') echo 'selected'; ?>>Current Quarter</option>
                                    <option value="last_quarter" <?php if(isset($_GET['period']) && $_GET['period'] == 'last_quarter') echo 'selected'; ?>>Last Quarter</option>
                                    <option value="current_year" <?php if(isset($_GET['period']) && $_GET['period'] == 'current_year') echo 'selected'; ?>>Current Year</option>
                                    <option value="last_year" <?php if(isset($_GET['period']) && $_GET['period'] == 'last_year') echo 'selected'; ?>>Last Year</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label for="analytics_department">Department</label>
                                <select id="analytics_department" class="form-control">
                                    <option value="">All Departments</option>
                                    <?php 
                                    $departments = array_unique(array_column($employees, 'department'));
                                    foreach ($departments as $department) {
                                        echo "<option value='" . htmlspecialchars($department) . "'";
                                        if(isset($_GET['department']) && $_GET['department'] == $department) echo ' selected';
                                        echo ">" . htmlspecialchars($department) . "</option>";
                                    }
                                    ?>
                                </select>
                            </div>
                            
                            <div class="form-group" style="display: flex; align-items: flex-end;">
                                <button class="btn" id="generateAnalytics"><i class="fas fa-chart-pie"></i> Generate Analytics</button>
                            </div>
                        </div>
                    </div>
                    
                    <?php if (!empty($analytics_data)): ?>
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-icon">
                                    <i class="fas fa-star"></i>
                                </div>
                                <div class="stat-value"><?php echo round($analytics_data['metrics']['avg_rating'], 1); ?>/10</div>
                                <div class="stat-label">Average Rating</div>
                            </div>
                            
                            <div class="stat-card">
                                <div class="stat-icon">
                                    <i class="fas fa-clipboard-check"></i>
                                </div>
                                <div class="stat-value"><?php echo $analytics_data['metrics']['total_reviews']; ?></div>
                                <div class="stat-label">Total Reviews</div>
                            </div>
                            
                            <div class="stat-card">
                                <div class="stat-icon">
                                    <i class="fas fa-trophy"></i>
                                </div>
                                <div class="stat-value"><?php echo $analytics_data['metrics']['top_performers']; ?></div>
                                <div class="stat-label">Top Performers</div>
                            </div>
                            
                            <div class="stat-card">
                                <div class="stat-icon">
                                    <i class="fas fa-exclamation-circle"></i>
                                </div>
                                <div class="stat-value"><?php echo $analytics_data['metrics']['needs_improvement']; ?></div>
                                <div class="stat-label">Needs Improvement</div>
                            </div>
                        </div>
                        
                        <div class="analytics-grid">
                            <div class="analytics-card">
                                <h3 class="analytics-title"><i class="fas fa-chart-line"></i> Performance Trends</h3>
                                <div class="chart-container">
                                    <canvas id="trendAnalyticsChart"></canvas>
                                </div>
                            </div>
                            
                            <div class="analytics-card">
                                <h3 class="analytics-title"><i class="fas fa-chart-pie"></i> Performance Distribution</h3>
                                <div class="chart-container">
                                    <canvas id="distributionAnalyticsChart"></canvas>
                                </div>
                            </div>
                        </div>
                        
                        <?php if (!empty($analytics_data['goals'])): ?>
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-icon">
                                    <i class="fas fa-bullseye"></i>
                                </div>
                                <div class="stat-value"><?php echo round($analytics_data['goals']['avg_goal_progress'], 1); ?>%</div>
                                <div class="stat-label">Avg Goal Progress</div>
                            </div>
                            
                            <div class="stat-card">
                                <div class="stat-icon">
                                    <i class="fas fa-tasks"></i>
                                </div>
                                <div class="stat-value"><?php echo $analytics_data['goals']['total_goals']; ?></div>
                                <div class="stat-label">Total Goals</div>
                            </div>
                            
                            <div class="stat-card">
                                <div class="stat-icon">
                                    <i class="fas fa-check-circle"></i>
                                </div>
                                <div class="stat-value"><?php echo $analytics_data['goals']['completed_goals']; ?></div>
                                <div class="stat-label">Completed Goals</div>
                            </div>
                            
                            <div class="stat-card">
                                <div class="stat-icon">
                                    <i class="fas fa-exclamation-triangle"></i>
                                </div>
                                <div class="stat-value"><?php echo $analytics_data['goals']['goals_needing_attention']; ?></div>
                                <div class="stat-label">Goals Needing Attention</div>
                            </div>
                        </div>
                        <?php endif; ?>
                        
                        <?php if (!empty($analytics_data['recognition'])): ?>
                        <div class="data-section">
                            <h3 class="form-title"><i class="fas fa-award"></i> Recognition Summary</h3>
                            <div style="overflow-x: auto;">
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th>Recognition Type</th>
                                            <th>Total Count</th>
                                            <th>Recognized Employees</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <?php foreach ($analytics_data['recognition'] as $recognition): ?>
                                            <tr>
                                                <td><?php echo htmlspecialchars($recognition['recognition_type']); ?></td>
                                                <td><?php echo $recognition['total_recognitions']; ?></td>
                                                <td><?php echo $recognition['recognized_employees']; ?></td>
                                            </tr>
                                        <?php endforeach; ?>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <?php endif; ?>
                    <?php endif; ?>
                    
                    <div class="data-section">
                        <h3 class="form-title"><i class="fas fa-table"></i> Performance Metrics</h3>
                        <div style="overflow-x: auto;">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Metric</th>
                                        <th>Current Period</th>
                                        <th>Previous Period</th>
                                        <th>Change</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>Average Rating</td>
                                        <td>7.8</td>
                                        <td>7.5</td>
                                        <td><span class="badge badge-success">+0.3</span></td>
                                    </tr>
                                    <tr>
                                        <td>Top Performers</td>
                                        <td>24</td>
                                        <td>20</td>
                                        <td><span class="badge badge-success">+4</span></td>
                                    </tr>
                                    <tr>
                                        <td>Employees Needing Improvement</td>
                                        <td>8</td>
                                        <td>10</td>
                                        <td><span class="badge badge-success">-2</span></td>
                                    </tr>
                                    <tr>
                                        <td>Completion Rate</td>
                                        <td>92%</td>
                                        <td>88%</td>
                                        <td><span class="badge badge-success">+4%</span></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                <?php endif; ?>
                
                <?php if ($active_section == 'goals'): ?>
                    <h2 class="section-title"><i class="fas fa-bullseye"></i> Goals & OKRs</h2>
                    
                    <div class="form-section">
                        <h3 class="form-title"><i class="fas fa-plus-circle"></i> Create New Goal</h3>
                        <form method="POST" id="goal-form">
                            <div class="form-grid">
                                <div class="form-group">
                                    <label for="goal_employee">Employee</label>
                                    <select id="goal_employee" name="goal_employee" class="form-control" required>
                                        <option value="">Select Employee</option>
                                        <?php foreach ($employees as $employee): ?>
                                            <option value="<?php echo $employee['id']; ?>">
                                                <?php echo htmlspecialchars($employee['name'] . ' (' . $employee['department'] . ')'); ?>
                                            </option>
                                        <?php endforeach; ?>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label for="goal_title">Goal Title</label>
                                    <input type="text" id="goal_title" name="goal_title" class="form-control" required>
                                </div>
                                
                                <div class="form-group">
                                    <label for="goal_category">Category</label>
                                    <select id="goal_category" name="goal_category" class="form-control" required>
                                        <option value="">Select Category</option>
                                        <option value="performance">Performance</option>
                                        <option value="development">Development</option>
                                        <option value="project">Project</option>
                                        <option value="behavioral">Behavioral</option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label for="goal_start_date">Start Date</label>
                                    <input type="date" id="goal_start_date" name="goal_start_date" class="form-control" value="<?php echo date('Y-m-d'); ?>" required>
                                </div>
                                
                                <div class="form-group">
                                    <label for="goal_end_date">Target Date</label>
                                    <input type="date" id="goal_end_date" name="goal_end_date" class="form-control" required>
                                </div>
                                
                                <div class="form-group">
                                    <label for="goal_progress">Progress (%)</label>
                                    <input type="number" id="goal_progress" name="goal_progress" class="form-control" min="0" max="100" value="0">
                                </div>
                                
                                <div class="form-group" style="grid-column: 1 / -1;">
                                    <label for="goal_description">Description</label>
                                    <textarea id="goal_description" name="goal_description" class="form-control" rows="3"></textarea>
                                </div>
                                
                                <div class="form-group" style="grid-column: 1 / -1;">
                                    <label for="goal_measurement">Measurement Criteria</label>
                                    <textarea id="goal_measurement" name="goal_measurement" class="form-control" rows="3"></textarea>
                                </div>
                            </div>
                            
                            <button type="submit" name="add_goal" class="btn"><i class="fas fa-save"></i> Create Goal</button>
                        </form>
                    </div>
                    
                    <div class="filter-section">
                        <div class="filter-group">
                            <label for="goal_filter_employee">Filter by Employee</label>
                            <select id="goal_filter_employee" class="form-control">
                                <option value="">All Employees</option>
                                <?php foreach ($employees as $employee): ?>
                                    <option value="<?php echo $employee['id']; ?>"><?php echo htmlspecialchars($employee['name']); ?></option>
                                <?php endforeach; ?>
                            </select>
                        </div>
                        
                        <div class="filter-group">
                            <label for="goal_filter_category">Filter by Category</label>
                            <select id="goal_filter_category" class="form-control">
                                <option value="">All Categories</option>
                                <option value="performance">Performance</option>
                                <option value="development">Development</option>
                                <option value="project">Project</option>
                                <option value="behavioral">Behavioral</option>
                            </select>
                        </div>
                        
                        <div class="filter-group" style="align-self: flex-end;">
                            <button class="btn" id="applyGoalFilters"><i class="fas fa-filter"></i> Apply Filters</button>
                        </div>
                    </div>
                    
                    <div class="data-section">
                        <h3 class="form-title"><i class="fas fa-tasks"></i> Active Goals</h3>
                        
                        <div id="goalsList">
                            <?php if (count($goals_data) > 0): ?>
                                <?php foreach ($goals_data as $goal): ?>
                                    <div class="goal-card">
                                        <div class="goal-header">
                                            <div class="goal-title"><?php echo htmlspecialchars($goal['goal_description']); ?></div>
                                            <!-- FIXED: Display a default category since goal_category doesn't exist in the database -->
                                            <span class="badge badge-info">Goal</span>
                                        </div>
                                        <div class="goal-progress">
                                            <div class="progress-bar">
                                                <div class="progress-fill" style="width: <?php echo $goal['goal_progress']; ?>%;"></div>
                                            </div>
                                            <div style="display: flex; justify-content: space-between; margin-top: 5px;">
                                                <span><?php echo $goal['goal_progress']; ?>% Complete</span>
                                                <span>Due: <?php echo date('M j, Y', strtotime($goal['goal_target_date'])); ?></span>
                                            </div>
                                        </div>
                                        <p><strong>Employee:</strong> <?php echo htmlspecialchars($goal['employee_name']); ?> (<?php echo htmlspecialchars($goal['department']); ?>)</p>
                                        <p><strong>Status:</strong> <?php echo htmlspecialchars($goal['goal_status']); ?></p>
                                    </div>
                                <?php endforeach; ?>
                            <?php else: ?>
                                <p style="text-align: center;">No goals found.</p>
                            <?php endif; ?>
                        </div>
                    </div>
                <?php endif; ?>
                
                <?php if ($active_section == 'recognition'): ?>
                    <h2 class="section-title"><i class="fas fa-award"></i> Employee Recognition</h2>
                    
                    <div class="form-section">
                        <h3 class="form-title"><i class="fas fa-medal"></i> Recognize Employee</h3>
                        <form method="POST" id="recognition-form">
                            <div class="form-grid">
                                <div class="form-group">
                                    <label for="recognition_employee">Employee</label>
                                    <select id="recognition_employee" name="recognition_employee" class="form-control" required>
                                        <option value="">Select Employee</option>
                                        <?php foreach ($employees as $employee): ?>
                                            <option value="<?php echo $employee['id']; ?>">
                                                <?php echo htmlspecialchars($employee['name'] . ' (' . $employee['department'] . ')'); ?>
                                            </option>
                                        <?php endforeach; ?>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label for="recognition_type">Recognition Type</label>
                                    <select id="recognition_type" name="recognition_type" class="form-control" required>
                                        <option value="">Select Type</option>
                                        <option value="Employee of the Month">Employee of the Month</option>
                                        <option value="Excellent Performance">Excellent Performance</option>
                                        <option value="Team Player">Team Player</option>
                                        <option value="Innovation">Innovation</option>
                                        <option value="Customer Service">Customer Service</option>
                                        <option value="Leadership">Leadership</option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label for="recognition_date">Date</label>
                                    <input type="date" id="recognition_date" name="recognition_date" class="form-control" value="<?php echo date('Y-m-d'); ?>" required>
                                </div>
                                
                                <div class="form-group" style="grid-column: 1 / -1;">
                                    <label for="recognition_reason">Reason</label>
                                    <textarea id="recognition_reason" name="recognition_reason" class="form-control" rows="3" required></textarea>
                                </div>
                            </div>
                            
                            <button type="submit" name="add_recognition" class="btn"><i class="fas fa-award"></i> Give Recognition</button>
                        </form>
                    </div>
                    
                    <div class="filter-section">
                        <div class="filter-group">
                            <label for="recognition_filter_employee">Filter by Employee</label>
                            <select id="recognition_filter_employee" class="form-control">
                                <option value="">All Employees</option>
                                <?php foreach ($employees as $employee): ?>
                                    <option value="<?php echo $employee['id']; ?>"><?php echo htmlspecialchars($employee['name']); ?></option>
                                <?php endforeach; ?>
                            </select>
                        </div>
                        
                        <div class="filter-group">
                            <label for="recognition_filter_type">Filter by Type</label>
                            <select id="recognition_filter_type" class="form-control">
                                <option value="">All Types</option>
                                <option value="Employee of the Month">Employee of the Month</option>
                                <option value="Excellent Performance">Excellent Performance</option>
                                <option value="Team Player">Team Player</option>
                                <option value="Innovation">Innovation</option>
                                <option value="Customer Service">Customer Service</option>
                                <option value="Leadership">Leadership</option>
                            </select>
                        </div>
                        
                        <div class="filter-group" style="align-self: flex-end;">
                            <button class="btn" id="applyRecognitionFilters"><i class="fas fa-filter"></i> Apply Filters</button>
                        </div>
                    </div>
                    
                    <div class="data-section">
                        <h3 class="form-title"><i class="fas fa-trophy"></i> Recent Recognitions</h3>
                        
                        <div id="recognitionList">
                            <?php if (count($recognition_data) > 0): ?>
                                <?php foreach ($recognition_data as $recognition): ?>
                                    <div class="recognition-item">
                                        <div class="recognition-icon">
                                            <?php
                                            $icon = 'fa-star';
                                            switch ($recognition['recognition_type']) {
                                                case 'Employee of the Month':
                                                    $icon = 'fa-trophy';
                                                    break;
                                                case 'Excellent Performance':
                                                    $icon = 'fa-star';
                                                    break;
                                                case 'Team Player':
                                                    $icon = 'fa-users';
                                                    break;
                                                case 'Innovation':
                                                    $icon = 'fa-lightbulb';
                                                    break;
                                                case 'Customer Service':
                                                    $icon = 'fa-handshake';
                                                    break;
                                                case 'Leadership':
                                                    $icon = 'fa-crown';
                                                    break;
                                            }
                                            ?>
                                            <i class="fas <?php echo $icon; ?>"></i>
                                        </div>
                                        <div class="recognition-content">
                                            <div class="recognition-title"><?php echo htmlspecialchars($recognition['employee_name']); ?> - <?php echo htmlspecialchars($recognition['recognition_type']); ?></div>
                                            <div><?php echo htmlspecialchars($recognition['recognition_reason']); ?></div>
                                            <div class="recognition-date"><?php echo date('M j, Y', strtotime($recognition['recognition_date'])); ?></div>
                                        </div>
                                    </div>
                                <?php endforeach; ?>
                            <?php else: ?>
                                <p style="text-align: center;">No recognitions found.</p>
                            <?php endif; ?>
                        </div>
                    </div>
                <?php endif; ?>
                
                <?php if ($active_section == 'reports'): ?>
                    <h2 class="section-title"><i class="fas fa-chart-pie"></i> Performance Reports</h2>
                    
                    <div class="form-section">
                        <h3 class="form-title"><i class="fas fa-file-alt"></i> Generate Report</h3>
                        <form method="POST" id="report-form">
                            <div class="form-grid">
                                <div class="form-group">
                                    <label for="report_type">Report Type</label>
                                    <select id="report_type" name="report_type" class="form-control" required>
                                        <option value="">Select Report Type</option>
                                        <option value="Performance Summary">Performance Summary</option>
                                        <option value="Department Comparison">Department Comparison</option>
                                        <option value="Top Performers">Top Performers</option>
                                        <option value="Improvement Needed">Improvement Needed</option>
                                        <option value="Goal Progress">Goal Progress</option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label for="report_period">Period</label>
                                    <select id="report_period" name="report_period" class="form-control" required>
                                        <option value="">Select Period</option>
                                        <option value="Monthly">Monthly</option>
                                        <option value="Quarterly">Quarterly</option>
                                        <option value="Semi-Annual">Semi-Annual</option>
                                        <option value="Annual">Annual</option>
                                        <option value="Custom">Custom Range</option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label for="report_department">Department</label>
                                    <select id="report_department" name="report_department" class="form-control">
                                        <option value="">All Departments</option>
                                        <?php 
                                        $departments = array_unique(array_column($employees, 'department'));
                                        foreach ($departments as $department) {
                                            echo "<option value='" . htmlspecialchars($department) . "'>" . htmlspecialchars($department) . "</option>";
                                        }
                                        ?>
                                    </select>
                                </div>
                                
                                <div class="form-group" style="display: flex; align-items: flex-end;">
                                    <button type="submit" name="generate_report" class="btn"><i class="fas fa-file-download"></i> Generate Report</button>
                                </div>
                            </div>
                        </form>
                    </div>
                    
                    <div class="data-section">
                        <h3 class="form-title"><i class="fas fa-history"></i> Recent Reports</h3>
                        
                        <div style="overflow-x: auto;">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Report Name</th>
                                        <th>Type</th>
                                        <th>Period</th>
                                        <th>Generated Date</th>
                                        <th>Generated By</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <?php if (count($reports_data) > 0): ?>
                                        <?php foreach ($reports_data as $report): ?>
                                            <tr>
                                                <td><?php echo htmlspecialchars($report['report_category']); ?> Report</td>
                                                <td><?php echo htmlspecialchars($report['report_category']); ?></td>
                                                <td><?php echo htmlspecialchars($report['report_period']); ?></td>
                                                <td><?php echo date('M j, Y', strtotime($report['report_generated_date'])); ?></td>
                                                <td><?php echo htmlspecialchars($report['report_generated_by_name']); ?></td>
                                                <td>
                                                    <a href="performance_management.php?section=reports&action=view&report_id=<?php echo $report['id']; ?>" class="btn btn-secondary" style="padding: 5px 10px; font-size: 14px; margin-right: 5px;">
                                                        <i class="fas fa-eye"></i> View
                                                    </a>
                                                    <a href="performance_management.php?section=reports&action=download&report_id=<?php echo $report['id']; ?>" class="btn btn-secondary" style="padding: 5px 10px; font-size: 14px;">
                                                        <i class="fas fa-download"></i> Download
                                                    </a>
                                                </td>
                                            </tr>
                                        <?php endforeach; ?>
                                    <?php else: ?>
                                        <tr>
                                            <td colspan="6" style="text-align: center;">No reports found.</td>
                                        </tr>
                                    <?php endif; ?>
                                </tbody>
                            </table>
                        </div>
                    </div>
                <?php endif; ?>
                
                <?php if ($active_section == 'settings'): ?>
                    <h2 class="section-title"><i class="fas fa-cog"></i> Performance Settings</h2>
                    
                    <div class="settings-grid">
                        <div class="settings-card">
                            <h3 class="settings-title"><i class="fas fa-star"></i> Rating Scale</h3>
                            <div class="form-group">
                                <label for="min_rating">Minimum Rating</label>
                                <input type="number" id="min_rating" class="form-control" value="1" min="0">
                            </div>
                            <div class="form-group">
                                <label for="max_rating">Maximum Rating</label>
                                <input type="number" id="max_rating" class="form-control" value="10" min="1">
                            </div>
                            <div class="form-group">
                                <label for="rating_increment">Rating Increment</label>
                                <input type="number" id="rating_increment" class="form-control" value="0.1" min="0.1" step="0.1">
                            </div>
                            <button class="btn" id="saveRatingScale"><i class="fas fa-save"></i> Save Settings</button>
                        </div>
                        
                        <div class="settings-card">
                            <h3 class="settings-title"><i class="fas fa-bell"></i> Notifications</h3>
                            <div class="form-group">
                                <div>
                                    <input type="checkbox" id="review_reminder" checked>
                                    <label for="review_reminder">Review Reminders</label>
                                </div>
                            </div>
                            <div class="form-group">
                                <div>
                                    <input type="checkbox" id="goal_reminder" checked>
                                    <label for="goal_reminder">Goal Deadline Reminders</label>
                                </div>
                            </div>
                            <div class="form-group">
                                <div>
                                    <input type="checkbox" id="performance_alert" checked>
                                    <label for="performance_alert">Low Performance Alerts</label>
                                </div>
                            </div>
                            <button class="btn" id="saveNotifications"><i class="fas fa-save"></i> Save Settings</button>
                        </div>
                        
                        <div class="settings-card">
                            <h3 class="settings-title"><i class="fas fa-calendar-alt"></i> Review Cycle</h3>
                            <div class="form-group">
                                <label for="review_frequency">Review Frequency</label>
                                <select id="review_frequency" class="form-control">
                                    <option value="monthly">Monthly</option>
                                    <option value="quarterly" selected>Quarterly</option>
                                    <option value="semi_annual">Semi-Annual</option>
                                    <option value="annual">Annual</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="review_advance_notice">Advance Notice (days)</label>
                                <input type="number" id="review_advance_notice" class="form-control" value="14" min="1">
                            </div>
                            <button class="btn" id="saveReviewCycle"><i class="fas fa-save"></i> Save Settings</button>
                        </div>
                    </div>
                <?php endif; ?>
            </div>
        </div>
    </div>
    
    <!-- Performance Review Details Modal -->
    <div id="performanceModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Performance Review Details</h3>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                <div class="detail-grid">
                    <div class="detail-item">
                        <div class="detail-label">Employee</div>
                        <div class="detail-value" id="modal-employee"></div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Department</div>
                        <div class="detail-value" id="modal-department"></div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Review Date</div>
                        <div class="detail-value" id="modal-review-date"></div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Reviewer</div>
                        <div class="detail-value" id="modal-reviewer"></div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Performance Rating</div>
                        <div class="detail-value" id="modal-rating"></div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Next Review Date</div>
                        <div class="detail-value" id="modal-next-review"></div>
                    </div>
                </div>
                
                <div class="detail-section">
                    <h4>Goals Achievement</h4>
                    <p id="modal-goals-achievement">No goals achievement data available.</p>
                </div>
                
                <div class="detail-section">
                    <h4>Strengths</h4>
                    <p id="modal-strengths">No strengths data available.</p>
                </div>
                
                <div class="detail-section">
                    <h4>Areas for Improvement</h4>
                    <p id="modal-areas-improvement">No areas for improvement data available.</p>
                </div>
                
                <div class="detail-section">
                    <h4>Recommendations</h4>
                    <p id="modal-recommendations">No recommendations data available.</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Report View Modal -->
    <div id="reportModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="reportModalTitle">Report View</h3>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                <div class="report-content" id="reportContent">
                    <!-- Report content will be loaded here -->
                </div>
            </div>
        </div>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Tab functionality
            const tabs = document.querySelectorAll('.tab');
            const tabContents = document.querySelectorAll('.tab-content');
            
            tabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabId = this.getAttribute('data-tab');
                    
                    // Remove active class from all tabs and contents
                    tabs.forEach(t => t.classList.remove('active'));
                    tabContents.forEach(c => c.classList.remove('active'));
                    
                    // Add active class to current tab and content
                    this.classList.add('active');
                    document.getElementById(`${tabId}-tab`).classList.add('active');
                });
            });
            
            // Modal functionality
            const modal = document.getElementById('performanceModal');
            const reportModal = document.getElementById('reportModal');
            const closeBtns = document.querySelectorAll('.close');
            
            // Close modal when clicking on X button
            closeBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    modal.style.display = 'none';
                    reportModal.style.display = 'none';
                });
            });
            
            // Close modal when clicking outside of it
            window.addEventListener('click', function(event) {
                if (event.target == modal) {
                    modal.style.display = 'none';
                }
                if (event.target == reportModal) {
                    reportModal.style.display = 'none';
                }
            });
            
            // View performance details functionality
            document.querySelectorAll('.view-performance').forEach(button => {
                button.addEventListener('click', function() {
                    const reviewId = this.getAttribute('data-id');
                    
                    // Find the review data
                    <?php
                    // Convert PHP array to JavaScript object for easy access
                    echo "const reviewsData = " . json_encode($performance_reviews) . ";";
                    ?>
                    
                    const review = reviewsData.find(r => r.id == reviewId);
                    
                    if (review) {
                        // Populate modal with review data
                        document.getElementById('modal-employee').textContent = review.employee_name || 'N/A';
                        document.getElementById('modal-department').textContent = review.department || 'N/A';
                        document.getElementById('modal-review-date').textContent = review.review_date ? 
                            new Date(review.review_date).toLocaleDateString() : 'N/A';
                        document.getElementById('modal-reviewer').textContent = review.reviewer_name || 'N/A';
                        document.getElementById('modal-rating').textContent = review.performance_rating ? 
                            `${review.performance_rating}/10` : 'Not rated';
                        document.getElementById('modal-next-review').textContent = review.next_review_date ? 
                            new Date(review.next_review_date).toLocaleDateString() : 'N/A';
                        
                        document.getElementById('modal-goals-achievement').textContent = 
                            review.goals_achievement || 'No goals achievement data available.';
                        document.getElementById('modal-strengths').textContent = 
                            review.strengths || 'No strengths data available.';
                        document.getElementById('modal-areas-improvement').textContent = 
                            review.areas_for_improvement || 'No areas for improvement data available.';
                        document.getElementById('modal-recommendations').textContent = 
                            review.recommendations || 'No recommendations data available.';
                        
                        // Display the modal
                        modal.style.display = 'block';
                    }
                });
            });
            
            // Check if we need to show a report in the modal (for view action)
            <?php if (isset($view_report_data)): ?>
                document.getElementById('reportModalTitle').textContent = '<?php echo $view_report_data['title']; ?>';
                document.getElementById('reportContent').innerHTML = `<?php echo str_replace('`', '\\`', $view_report_data['content']); ?>`;
                reportModal.style.display = 'block';
            <?php endif; ?>
            
            // Rating Distribution Chart
            const ratingChartElement = document.getElementById('ratingChart');
            if (ratingChartElement) {
                const ratingCtx = ratingChartElement.getContext('2d');
                <?php if ($performance_stats['total_reviews'] > 0): ?>
                const ratingChart = new Chart(ratingCtx, {
                    type: 'bar',
                    data: {
                        labels: ['1', '2', '3', '4', '5', '6', '7', '8', '9', '10'],
                        datasets: [{
                            label: 'Number of Reviews',
                            data: [
                                <?php echo implode(', ', $performance_stats['rating_distribution']); ?>
                            ],
                            backgroundColor: [
                                '#dc3545', '#dc3545', '#fd7e14', '#fd7e14', '#ffc107',
                                '#ffc107', '#20c997', '#20c997', '#198754', '#198754'
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Number of Reviews'
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'Performance Rating'
                                }
                            }
                        },
                        plugins: {
                            title: {
                                display: true,
                                text: 'Performance Rating Distribution'
                            }
                        }
                    }
                });
                <?php else: ?>
                // Show empty state for rating chart
                ratingCtx.font = "16px Arial";
                ratingCtx.fillStyle = "#666";
                ratingCtx.textAlign = "center";
                ratingCtx.fillText("No performance data available", ratingCtx.canvas.width / 2, ratingCtx.canvas.height / 2);
                <?php endif; ?>
            }
            
            // Department Performance Chart
            const departmentChartElement = document.getElementById('departmentChart');
            if (departmentChartElement) {
                const deptCtx = departmentChartElement.getContext('2d');
                <?php if (count($performance_stats['department_stats']) > 0): ?>
                const deptLabels = [
                    <?php 
                    $deptLabels = [];
                    foreach ($performance_stats['department_stats'] as $dept => $stats) {
                        $deptLabels[] = "'" . addslashes($dept) . "'";
                    }
                    echo implode(', ', $deptLabels);
                    ?>
                ];
                
                const deptData = [
                    <?php 
                    $deptValues = [];
                    foreach ($performance_stats['department_stats'] as $stats) {
                        $deptValues[] = isset($stats['avg_rating']) ? $stats['avg_rating'] : 0;
                    }
                    echo implode(', ', $deptValues);
                    ?>
                ];
                
                const departmentChart = new Chart(deptCtx, {
                    type: 'pie',
                    data: {
                        labels: deptLabels,
                        datasets: [{
                            label: 'Average Rating',
                            data: deptData,
                            backgroundColor: [
                                '#4e73df', '#1cc88a', '#36b9cc', '#f6c23e', '#e74a3b',
                                '#858796', '#f8f9fc', '#5a5c69', '#2e59d9', '#17a673'
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: 'Average Rating by Department'
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return context.label + ': ' + context.raw + '/10';
                                    }
                                }
                            }
                        }
                    }
                });
                <?php else: ?>
                // Show empty state for department chart
                deptCtx.font = "16px Arial";
                deptCtx.fillStyle = "#666";
                deptCtx.textAlign = "center";
                deptCtx.fillText("No department data available", deptCtx.canvas.width / 2, deptCtx.canvas.height / 2);
                <?php endif; ?>
            }
            
            // Performance Trends Chart (simplified example)
            const trendChartElement = document.getElementById('trendChart');
            if (trendChartElement) {
                const trendCtx = trendChartElement.getContext('2d');
                <?php if (count($performance_reviews) > 0): ?>
                // This is a simplified example - in a real app you would calculate monthly averages
                const trendChart = new Chart(trendCtx, {
                    type: 'line',
                    data: {
                        labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
                        datasets: [{
                            label: 'Average Performance Rating',
                            data: [7.2, 7.5, 7.8, 8.1, 7.9, 8.3, 8.5, 8.2, 8.4, 8.6, 8.7, 8.9],
                            borderColor: '#4e73df',
                            backgroundColor: 'rgba(78, 115, 223, 0.05)',
                            fill: true,
                            tension: 0.3
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: false,
                                min: 6,
                                max: 10,
                                title: {
                                    display: true,
                                    text: 'Performance Rating'
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'Month'
                                }
                            }
                        },
                        plugins: {
                            title: {
                                display: true,
                                text: 'Monthly Performance Trends'
                            }
                        }
                    }
                });
                <?php else: ?>
                // Show empty state for trend chart
                trendCtx.font = "16px Arial";
                trendCtx.fillStyle = "#666";
                trendCtx.textAlign = "center";
                trendCtx.fillText("No trend data available", trendCtx.canvas.width / 2, trendCtx.canvas.height / 2);
                <?php endif; ?>
            }
            
            // Form validation
            const performanceForm = document.getElementById('performance-form');
            if (performanceForm) {
                performanceForm.addEventListener('submit', function(e) {
                    const rating = document.getElementById('performance_rating').value;
                    if (rating && (rating < 1 || rating > 10)) {
                        e.preventDefault();
                        alert('Performance rating must be between 1 and 10');
                        return false;
                    }
                });
            }
            
            // Employee Performance Report
            const generateEmployeePerf = document.getElementById('generateEmployeePerf');
            if (generateEmployeePerf) {
                generateEmployeePerf.addEventListener('click', function() {
                    const employeeId = document.getElementById('perf_employee_select').value;
                    const period = document.getElementById('perf_period').value;
                    
                    if (!employeeId) {
                        alert('Please select an employee.');
                        return;
                    }
                    
                    // Redirect to employee performance page with selected employee and period
                    window.location.href = 'performance_management.php?section=employee&employee_id=' + employeeId + '&period=' + period;
                });
            }
            
            // Employee Performance Chart
            const employeePerfChartElement = document.getElementById('employeePerfChart');
            if (employeePerfChartElement) {
                const employeePerfCtx = employeePerfChartElement.getContext('2d');
                
                // Prepare data for the chart
                const employeePerfLabels = [
                    <?php 
                    $labels = [];
                    foreach ($employee_performance_history as $review) {
                        $labels[] = "'" . date('M j, Y', strtotime($review['review_date'])) . "'";
                    }
                    echo implode(', ', array_reverse($labels)); // Reverse to show chronological order
                    ?>
                ];
                
                const employeePerfData = [
                    <?php 
                    $ratings = [];
                    foreach ($employee_performance_history as $review) {
                        $ratings[] = $review['performance_rating'] ?: 0;
                    }
                    echo implode(', ', array_reverse($ratings)); // Reverse to match labels
                    ?>
                ];
                
                const employeePerfChart = new Chart(employeePerfCtx, {
                    type: 'line',
                    data: {
                        labels: employeePerfLabels,
                        datasets: [{
                            label: 'Performance Rating',
                            data: employeePerfData,
                            backgroundColor: 'rgba(54, 162, 235, 0.2)',
                            borderColor: 'rgba(54, 162, 235, 1)',
                            borderWidth: 2,
                            tension: 0.3,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: false,
                                min: 0,
                                max: 10
                            }
                        }
                    }
                });
            }
            
            // Analytics
            const generateAnalytics = document.getElementById('generateAnalytics');
            if (generateAnalytics) {
                generateAnalytics.addEventListener('click', function() {
                    const period = document.getElementById('analytics_period').value;
                    const department = document.getElementById('analytics_department').value;
                    
                    // Redirect to analytics page with selected parameters
                    window.location.href = 'performance_management.php?section=analytics&period=' + period + '&department=' + department;
                });
            }
            
            // Analytics Charts
            <?php if (!empty($analytics_data)): ?>
            // Trends Chart
            const trendsAnalyticsChartElement = document.getElementById('trendAnalyticsChart');
            if (trendsAnalyticsChartElement) {
                const trendsAnalyticsCtx = trendsAnalyticsChartElement.getContext('2d');
                
                // Prepare data for the trends chart
                const trendsLabels = [
                    <?php 
                    $labels = [];
                    if (!empty($analytics_data['trends'])) {
                        foreach ($analytics_data['trends'] as $trend) {
                            $monthName = date('M', mktime(0, 0, 0, $trend['month'], 1));
                            $labels[] = "'" . $monthName . "'";
                        }
                    }
                    echo implode(', ', $labels);
                    ?>
                ];
                
                const trendsData = [
                    <?php 
                    $ratings = [];
                    if (!empty($analytics_data['trends'])) {
                        foreach ($analytics_data['trends'] as $trend) {
                            $ratings[] = $trend['avg_rating'];
                        }
                    }
                    echo implode(', ', $ratings);
                    ?>
                ];
                
                const trendsAnalyticsChart = new Chart(trendsAnalyticsCtx, {
                    type: 'line',
                    data: {
                        labels: trendsLabels,
                        datasets: [
                            {
                                label: 'Performance Rating',
                                data: trendsData,
                                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                                borderColor: 'rgba(75, 192, 192, 1)',
                                borderWidth: 2,
                                tension: 0.3,
                                fill: true
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: false
                            }
                        }
                    }
                });
            }
            
            // Distribution Chart
            const distributionAnalyticsChartElement = document.getElementById('distributionAnalyticsChart');
            if (distributionAnalyticsChartElement) {
                const distributionAnalyticsCtx = distributionAnalyticsChartElement.getContext('2d');
                
                const distributionData = [
                    <?php 
                    if (!empty($analytics_data['distribution'])) {
                        echo $analytics_data['distribution']['exceeds'] . ', ' . 
                             $analytics_data['distribution']['meets'] . ', ' . 
                             $analytics_data['distribution']['needs_improvement'];
                    } else {
                        echo '0, 0, 0';
                    }
                    ?>
                ];
                
                const distributionAnalyticsChart = new Chart(distributionAnalyticsCtx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Exceeds Expectations', 'Meets Expectations', 'Needs Improvement'],
                        datasets: [{
                            data: distributionData,
                            backgroundColor: [
                                'rgba(40, 167, 69, 0.6)',
                                'rgba(23, 162, 184, 0.6)',
                                'rgba(220, 53, 69, 0.6)'
                            ],
                            borderColor: [
                                'rgba(40, 167, 69, 1)',
                                'rgba(23, 162, 184, 1)',
                                'rgba(220, 53, 69, 1)'
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false
                    }
                });
            }
            <?php endif; ?>
            
            // Goal Filters
            const applyGoalFilters = document.getElementById('applyGoalFilters');
            if (applyGoalFilters) {
                applyGoalFilters.addEventListener('click', function() {
                    const employee = document.getElementById('goal_filter_employee').value;
                    const category = document.getElementById('goal_filter_category').value;
                    
                    // In a real implementation, this would filter the goals based on the selected criteria
                    window.location.href = 'performance_management.php?section=goals&employee_id=' + employee + '&category=' + category;
                });
            }
            
            // Recognition Filters
            const applyRecognitionFilters = document.getElementById('applyRecognitionFilters');
            if (applyRecognitionFilters) {
                applyRecognitionFilters.addEventListener('click', function() {
                    const employee = document.getElementById('recognition_filter_employee').value;
                    const type = document.getElementById('recognition_filter_type').value;
                    
                    // In a real implementation, this would filter the recognitions based on the selected criteria
                    window.location.href = 'performance_management.php?section=recognition&employee_id=' + employee + '&type=' + type;
                });
            }
            
            // Report Generation
            const reportForm = document.getElementById('report-form');
            if (reportForm) {
                reportForm.addEventListener('submit', function(e) {
                    const type = document.getElementById('report_type').value;
                    const period = document.getElementById('report_period').value;
                    
                    if (!type || !period) {
                        e.preventDefault();
                        alert('Please select report type and period.');
                        return false;
                    }
                    
                    // Form will submit normally to PHP handler
                    return true;
                });
            }
            
            // Settings
            const saveRatingScale = document.getElementById('saveRatingScale');
            if (saveRatingScale) {
                saveRatingScale.addEventListener('click', function() {
                    alert('Rating scale settings saved successfully!');
                });
            }
            
            const saveNotifications = document.getElementById('saveNotifications');
            if (saveNotifications) {
                saveNotifications.addEventListener('click', function() {
                    alert('Notification settings saved successfully!');
                });
            }
            
            const saveReviewCycle = document.getElementById('saveReviewCycle');
            if (saveReviewCycle) {
                saveReviewCycle.addEventListener('click', function() {
                    alert('Review cycle settings saved successfully!');
                });
            }
            
            // Auto-hide message after 5 seconds
            setTimeout(function() {
                const messageDiv = document.querySelector('.message');
                if (messageDiv) {
                    messageDiv.style.display = 'none';
                }
            }, 5000);
        });
    </script>
</body>
</html>